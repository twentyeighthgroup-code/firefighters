<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üî• FIRE HERO: TG EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@600;800&display=swap');

        :root {
            --hud-bg: rgba(10, 20, 30, 0.85);
            --accent: #ff4d00;
            --water: #00f0ff;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #050505;
            font-family: 'Rajdhani', sans-serif;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* –ë–ª–æ–∫–∏—Ä—É–µ–º –∑—É–º –∏ —Å–∫—Ä–æ–ª–ª */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Layer */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        /* HUD Top */
        .hud-top {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            padding-top: env(safe-area-inset-top); /* –î–ª—è iPhone —Å —á–µ–ª–∫–æ–π */
        }

        .stat-block {
            background: var(--hud-bg);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Black Ops One', cursive;
            color: #fff;
            text-shadow: 0 2px 0 #000;
        }

        .bar-container {
            width: 100px;
            height: 6px;
            background: #222;
            margin-top: 2px;
            border-radius: 3px;
            overflow: hidden;
        }
        .bar-fill { height: 100%; transition: width 0.2s; }
        #water-bar { background: linear-gradient(90deg, #0055ff, var(--water)); }
        #heat-bar { background: linear-gradient(90deg, #ffaa00, #ff0000); }

        /* CONTROLS (Mobile) */
        .controls-area {
            pointer-events: auto;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .d-pad, .action-pad {
            display: grid;
            gap: 10px;
        }

        .d-pad {
            grid-template-columns: 1fr 1fr;
            width: 140px;
        }

        .action-pad {
            grid-template-columns: 1fr 1fr;
            width: 150px;
            align-items: end;
        }

        .ctrl-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            backdrop-filter: blur(5px);
            transition: 0.1s;
            user-select: none;
        }

        .ctrl-btn:active, .ctrl-btn.active {
            background: rgba(255, 77, 0, 0.5);
            border-color: var(--accent);
            transform: scale(0.95);
        }

        .btn-shoot {
            width: 70px;
            height: 70px;
            background: rgba(0, 240, 255, 0.2);
            border-color: var(--water);
            grid-column: span 2;
            justify-self: center;
        }
        .btn-shoot:active { background: rgba(0, 240, 255, 0.6); }

        /* Modals */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s;
        }
        .modal.hidden { opacity: 0; pointer-events: none; }

        .panel {
            text-align: center;
            width: 90%;
            max-width: 400px;
            background: linear-gradient(145deg, #1a1a2e, #0d0d1a);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #333;
            box-shadow: 0 0 30px rgba(255, 77, 0, 0.2);
        }

        h1, h2 {
            font-family: 'Black Ops One';
            margin: 0 0 15px 0;
            background: linear-gradient(to bottom, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            background: linear-gradient(45deg, #c43a00, #ff4d00);
            border: none;
            padding: 15px 30px;
            font-family: 'Black Ops One';
            color: white;
            font-size: 20px;
            border-radius: 10px;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 5px 0 #802000;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }

        /* Shop Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            text-align: left;
            margin-bottom: 10px;
        }

        .upgrade-card {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .upgrade-card.disabled { opacity: 0.5; }
        .upg-name { font-size: 14px; font-weight: bold; color: var(--water); }
        .upg-cost { float: right; color: #ffcc00; font-weight: bold; }

        /* Float Text */
        #notifications { pointer-events: none; position: absolute; width: 100%; height: 100%; }
        .float-text {
            position: absolute;
            font-weight: 800;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: floatUp 1s forwards;
        }
        @keyframes floatUp {
            to { transform: translateY(-80px) scale(1.2); opacity: 0; }
        }
        
        .weather-alert {
            position: absolute;
            top: 80px;
            width: 100%;
            text-align: center;
            color: #fff;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 0 0 5px red;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-block">
                <div style="font-size:10px; color:#888;">–ë–ê–ö</div>
                <div class="bar-container"><div class="bar-fill" id="water-bar"></div></div>
            </div>
            
            <div class="stat-block">
                <div class="stat-value" id="money-display">$0</div>
            </div>

            <div class="stat-block">
                <div style="font-size:10px; color:#888;">–•–ê–û–°</div>
                <div class="bar-container"><div class="bar-fill" id="heat-bar"></div></div>
            </div>
        </div>

        <div id="notifications"></div>

        <!-- Touch Controls -->
        <div class="controls-area">
            <div class="d-pad">
                <div class="ctrl-btn" id="btn-left">‚¨Ö</div>
                <div class="ctrl-btn" id="btn-right">‚û°</div>
                <div class="ctrl-btn" id="btn-refill" style="grid-column: span 2; width: 100%; margin-top: 10px; border-color: #ff4444; font-size: 14px;">‚ö° –ó–ê–ü–†–ê–í–ö–ê</div>
            </div>
            
            <div class="action-pad">
                <div class="ctrl-btn" id="btn-up">‚¨Ü</div>
                <div class="ctrl-btn" id="btn-down">‚¨á</div>
                <div class="ctrl-btn btn-shoot" id="btn-shoot">üî•</div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="modal">
        <div class="panel">
            <h1>FIRE HERO</h1>
            <p style="color:#aaa; margin-bottom: 20px;">Telegram Edition</p>
            <p>–°–ø–∞—Å–∞–π –ª—é–¥–µ–π, —Å–ª–µ–¥–∏ –∑–∞ –≤–µ—Ç—Ä–æ–º, —É–ª—É—á—à–∞–π –ø—É—à–∫—É.</p>
            <button class="btn" onclick="game.start()">–ù–ê–ß–ê–¢–¨ –°–ú–ï–ù–£</button>
        </div>
    </div>

    <!-- Shop Screen -->
    <div id="shop-screen" class="modal hidden">
        <div class="panel">
            <h2 style="color: #00ff88;">–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù</h2>
            <p id="level-info" style="color:#ccc; font-size: 14px; margin-bottom:10px;"></p>
            
            <div class="shop-grid">
                <div class="upgrade-card" onclick="game.buyUpgrade('pressure')">
                    <div class="upg-name">–î–∞–≤–ª–µ–Ω–∏–µ</div>
                    <div class="upg-cost" id="cost-pressure">$100</div>
                </div>
                <div class="upgrade-card" onclick="game.buyUpgrade('tank')">
                    <div class="upg-name">–ë–∞–∫</div>
                    <div class="upg-cost" id="cost-tank">$150</div>
                </div>
                <div class="upgrade-card" onclick="game.buyUpgrade('speed')">
                    <div class="upg-name">–ú–æ—Ç–æ—Ä</div>
                    <div class="upg-cost" id="cost-speed">$200</div>
                </div>
                <div class="upgrade-card" onclick="game.buyUpgrade('nozzle')">
                    <div class="upg-name">–°–ø–ª–∏—Ç—Ç–µ—Ä</div>
                    <div class="upg-cost" id="cost-nozzle">$300</div>
                </div>
            </div>
            <button class="btn" onclick="game.nextLevel()">–°–õ–ï–î–£–Æ–©–ò–ô >> </button>
        </div>
    </div>

    <!-- Game Over -->
    <div id="game-over-screen" class="modal hidden">
        <div class="panel">
            <h1 style="color: red;">–ü–†–û–í–ê–õ</h1>
            <p>–ì–æ—Ä–æ–¥ —Å–≥–æ—Ä–µ–ª.</p>
            <p id="final-score" style="font-size: 20px; font-weight: bold; color: #fff;"></p>
            <button class="btn" onclick="location.reload()">–ó–ê–ù–û–í–û</button>
        </div>
    </div>

    <script>
        // Telegram WebApp Initialization
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand(); // Fullscreen
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });

        // Handle High DPI Screens (Retina)
        let W, H, scale;
        function resize() {
            W = window.innerWidth;
            H = window.innerHeight;
            scale = Math.min(2, window.devicePixelRatio); // Cap scale for performance
            
            canvas.width = W * scale;
            canvas.height = H * scale;
            canvas.style.width = W + 'px';
            canvas.style.height = H + 'px';
            
            ctx.scale(scale, scale);
        }
        window.addEventListener('resize', resize);
        resize();

        // --- UTILS ---
        const rand = (min, max) => Math.random() * (max - min) + min;
        const vibrate = (ms) => {
            if (navigator.vibrate) navigator.vibrate(ms);
        };

        // --- CONTROLS SYSTEM ---
        const keys = { left: false, right: false, up: false, down: false, shoot: false, refill: false };
        
        // Helper to bind touch events
        function bindTouch(id, key) {
            const btn = document.getElementById(id);
            const start = (e) => { e.preventDefault(); keys[key] = true; btn.classList.add('active'); };
            const end = (e) => { e.preventDefault(); keys[key] = false; btn.classList.remove('active'); };
            
            btn.addEventListener('touchstart', start, {passive: false});
            btn.addEventListener('touchend', end);
            btn.addEventListener('mousedown', start); // Debug on PC
            btn.addEventListener('mouseup', end);
        }

        bindTouch('btn-left', 'left');
        bindTouch('btn-right', 'right');
        bindTouch('btn-up', 'up');
        bindTouch('btn-down', 'down');
        bindTouch('btn-shoot', 'shoot');
        bindTouch('btn-refill', 'refill');

        // --- GAME ENGINE ---
        class Particle {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.life = 1.0;
                
                if (type === 'water') {
                    // Physics affected by wind
                    let angle = game.truck.angle;
                    let force = game.upgrades.pressure.val;
                    this.vx = Math.cos(angle) * force + rand(-0.5, 0.5);
                    this.vy = Math.sin(angle) * force + rand(-0.5, 0.5);
                    this.size = rand(3, 5);
                    this.color = `hsl(${rand(180, 220)}, 100%, 60%)`;
                    this.gravity = 0.25;
                } else if (type === 'fire') {
                    this.vx = rand(-0.5, 0.5);
                    this.vy = rand(-2, -0.5);
                    this.size = rand(8, 20);
                    this.decay = rand(0.02, 0.04);
                    this.gravity = -0.05;
                } else if (type === 'smoke') {
                    this.vx = game.wind * 0.5 + rand(-0.5, 0.5);
                    this.vy = rand(-1.5, -0.5);
                    this.size = rand(10, 25);
                    this.decay = 0.015;
                    this.gravity = 0;
                } else if (type === 'spark') {
                    this.vx = rand(-3, 3);
                    this.vy = rand(-3, 3);
                    this.size = rand(1, 2);
                    this.decay = 0.05;
                    this.gravity = 0.2;
                }
            }

            update() {
                // Wind effect
                if (this.type === 'water' || this.type === 'smoke') {
                    this.vx += game.wind * 0.05;
                }

                this.x += this.vx;
                this.y += this.vy;
                
                if (this.type === 'water' || this.type === 'spark') {
                    this.vy += this.gravity;
                }
                
                if (this.type === 'fire' || this.type === 'smoke' || this.type === 'spark') {
                    this.life -= this.decay;
                } else {
                    // Water collision with ground
                    if (this.y > H - 40) this.life = 0;
                    if (this.x > W + 100 || this.x < -100) this.life = 0;
                }
            }

            draw(ctx) {
                if (this.life <= 0) return;
                ctx.globalAlpha = this.life;
                
                if (this.type === 'water') {
                    ctx.fillStyle = this.color;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                } else if (this.type === 'fire') {
                    let hue = 60 - (1 - this.life) * 50; 
                    ctx.fillStyle = `hsla(${hue}, 100%, 50%, ${this.life})`;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                } else if (this.type === 'smoke') {
                    ctx.fillStyle = '#333';
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                } else if (this.type === 'spark') {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(this.x, this.y, this.size, this.size);
                }
                ctx.globalAlpha = 1.0;
            }
        }

        class Building {
            constructor(x, w, floors) {
                this.x = x;
                this.w = w;
                this.h = floors * 60;
                this.windows = [];
                
                for(let f=0; f<floors; f++) {
                    let winCount = Math.floor(w / 45);
                    for(let i=0; i<winCount; i++) {
                        this.windows.push({
                            x: x + 10 + i * 45,
                            y: (H - 40) - (f * 60) - 50,
                            w: 25, h: 35,
                            hp: 0, maxHp: 100,
                            person: Math.random() < 0.35,
                            saved: false, dead: false
                        });
                    }
                }
            }

            draw(ctx) {
                ctx.fillStyle = '#111';
                ctx.fillRect(this.x, H - 40 - this.h, this.w, this.h);
                
                // Lights overlay
                ctx.fillStyle = 'rgba(255,255,255,0.05)';
                ctx.fillRect(this.x + 5, H - 40 - this.h, 5, this.h);

                this.windows.forEach(win => {
                    if (win.hp >= 100) ctx.fillStyle = '#000'; // Burnt
                    else if (win.hp > 0) ctx.fillStyle = `rgba(255, ${100-win.hp}, 0, ${0.6})`; // Fire
                    else ctx.fillStyle = '#223'; // Normal

                    ctx.fillRect(win.x, win.y, win.w, win.h);

                    if (win.person && !win.saved && !win.dead) {
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#fff';
                        ctx.fillText('üôã', win.x + 4, win.y + 25);
                        if (win.hp > 0) {
                            ctx.font = '10px Arial';
                            ctx.fillStyle = 'red';
                            ctx.fillText('SOS', win.x+2, win.y - 5);
                        }
                    }

                    // Generate particles for fire
                    if (win.hp > 0 && win.hp < 100 && Math.random() < 0.1) {
                        game.particles.push(new Particle(win.x + rand(0, win.w), win.y + win.h, 'fire'));
                        if (Math.random() < 0.5) game.particles.push(new Particle(win.x + rand(0, win.w), win.y, 'smoke'));
                    }
                });
            }
        }

        class Truck {
            constructor() {
                this.x = 50;
                this.y = H - 65;
                this.w = 100;
                this.h = 40;
                this.angle = -Math.PI / 4;
                this.water = 100;
                this.maxWater = 100;
                this.money = 0;
            }

            update() {
                if (keys.left && this.x > 0) this.x -= game.upgrades.speed.val;
                if (keys.right && this.x < W - this.w) this.x += game.upgrades.speed.val;
                if (keys.up && this.angle > -Math.PI + 0.2) this.angle -= 0.04;
                if (keys.down && this.angle < 0) this.angle += 0.04;

                if (keys.refill) {
                    if (this.x < 100) {
                        if (this.water < this.maxWater) {
                            this.water += 2;
                            if(this.water % 10 === 0) vibrate(5);
                        }
                    } else {
                        game.showFloat("–ì–ò–î–†–ê–ù–¢ –°–õ–ï–í–ê!", this.x, this.y - 50, "red");
                    }
                }

                if (keys.shoot && this.water > 0) {
                    this.water -= 0.4;
                    vibrate(10); // Tactile feedback
                    
                    let count = game.upgrades.nozzle.active ? 4 : 1;
                    for(let i=0; i<count; i++) {
                        game.particles.push(new Particle(this.x + 60, this.y - 5, 'water'));
                    }
                }
            }

            draw(ctx) {
                // Body
                ctx.fillStyle = '#d00';
                ctx.fillRect(this.x, this.y, this.w, this.h);
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x + 70, this.y + 5, 25, 15); // Window
                
                // Cannon
                ctx.save();
                ctx.translate(this.x + 60, this.y);
                ctx.rotate(this.angle);
                ctx.fillStyle = '#888';
                ctx.fillRect(0, -6, 35, 12);
                ctx.restore();

                // Wheels
                ctx.fillStyle = '#222';
                ctx.beginPath(); ctx.arc(this.x + 25, this.y + 40, 12, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(this.x + 80, this.y + 40, 12, 0, Math.PI*2); ctx.fill();
            }
        }

        const game = {
            state: 'menu',
            level: 1,
            wind: 0,
            particles: [],
            buildings: [],
            truck: null,
            heat: 0, maxHeat: 1000,
            
            upgrades: {
                pressure: { val: 10, cost: 100, level: 1 },
                tank: { val: 100, cost: 150, level: 1 },
                speed: { val: 2, cost: 200, level: 1 },
                nozzle: { active: false, cost: 300, level: 1 }
            },

            showFloat(text, x, y, color) {
                const el = document.createElement('div');
                el.className = 'float-text';
                el.innerText = text;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                el.style.color = color;
                document.getElementById('notifications').appendChild(el);
                setTimeout(() => el.remove(), 1000);
            },

            init() {
                this.truck = new Truck();
                this.loop();
            },

            start() {
                document.getElementById('start-screen').classList.add('hidden');
                this.state = 'play';
                this.level = 1;
                this.truck.money = 0;
                this.loadLevel();
            },

            loadLevel() {
                this.buildings = [];
                this.particles = [];
                this.heat = 0;
                
                // Difficulty Scaling
                // Wind: -2 to 2. Level 3+ gets stronger wind.
                if (this.level >= 3) {
                    this.wind = rand(-2, 2);
                    let wText = this.wind > 0 ? "–í–ï–¢–ï–†: –í–ü–†–ê–í–û >>" : "–í–ï–¢–ï–†: << –í–õ–ï–í–û";
                    this.showFloat(wText, W/2 - 50, H/2, "#0ff");
                } else {
                    this.wind = 0;
                }

                let x = 150;
                const count = 2 + Math.min(Math.floor(this.level / 2), 3);
                
                for(let i=0; i<count; i++) {
                    let w = rand(80, 150);
                    // Height increases with level
                    let floors = rand(2, 3 + Math.floor(this.level/3));
                    this.buildings.push(new Building(x, w, floors));
                    x += w + rand(20, 60);
                }

                // Start fires
                let fireCount = 2 + this.level;
                let allWindows = this.buildings.flatMap(b => b.windows);
                for(let i=0; i<fireCount; i++) {
                    let win = allWindows[Math.floor(Math.random() * allWindows.length)];
                    if(win) win.hp = 60;
                }
            },

            update() {
                if (this.state !== 'play') return;

                this.truck.update();

                // Particles
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    let p = this.particles[i];
                    p.update();

                    if (p.type === 'water') {
                        this.buildings.forEach(b => {
                            b.windows.forEach(win => {
                                if (win.hp > 0 && win.hp < 100) {
                                    // Simple collision
                                    if (p.x > win.x && p.x < win.x + win.w &&
                                        p.y > win.y && p.y < win.y + win.h) {
                                        p.life = 0;
                                        win.hp -= 3;
                                        if(Math.random() < 0.3) this.particles.push(new Particle(p.x, p.y, 'smoke'));
                                        
                                        if (win.hp <= 0) {
                                            win.hp = 0;
                                            this.truck.money += 15;
                                            this.showFloat("+$15", win.x, win.y, "yellow");
                                            
                                            if (win.person && !win.dead) {
                                                win.saved = true;
                                                this.truck.money += 60;
                                                this.showFloat("–°–ü–ê–°–ï–ù! +$60", win.x, win.y-20, "#0f0");
                                                vibrate(50);
                                            }
                                        }
                                    }
                                }
                            });
                        });
                    }
                    if (p.life <= 0) this.particles.splice(i, 1);
                }

                // Game Logic
                let burning = 0;
                let totalFire = 0;

                this.buildings.forEach(b => {
                    b.windows.forEach(win => {
                        if (win.hp > 0 && win.hp < 100) {
                            burning++;
                            win.hp += 0.08 + (this.level * 0.01);
                            totalFire += win.hp;
                            
                            if (win.hp >= 100) {
                                if (win.person && !win.saved) {
                                    win.dead = true;
                                    this.heat += 300;
                                    vibrate(200);
                                    this.showFloat("üíÄ", win.x, win.y, "red");
                                }
                            }
                        }
                    });
                });

                this.heat += burning * 0.2;
                if (this.heat >= this.maxHeat) this.gameOver();

                if (burning === 0 && totalFire === 0 && this.particles.filter(p=>p.type==='water').length === 0) {
                    setTimeout(() => this.levelComplete(), 500);
                }
            },

            draw() {
                ctx.fillStyle = '#050505';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Ground
                ctx.fillStyle = '#151515';
                ctx.fillRect(0, H - 40, W, 40);
                // Hydrant
                ctx.fillStyle = '#f00';
                ctx.fillRect(60, H - 55, 15, 15);

                this.buildings.forEach(b => b.draw(ctx));
                this.truck.draw(ctx);
                this.particles.forEach(p => p.draw(ctx));

                // UI Updates
                document.getElementById('water-bar').style.width = (this.truck.water) + '%';
                document.getElementById('heat-bar').style.width = (this.heat / this.maxHeat * 100) + '%';
                document.getElementById('money-display').innerText = '$' + Math.floor(this.truck.money);
            },

            loop() {
                requestAnimationFrame(() => this.loop());
                this.update();
                this.draw();
            },

            levelComplete() {
                if (this.state !== 'play') return;
                this.state = 'shop';
                document.getElementById('shop-screen').classList.remove('hidden');
                document.getElementById('level-info').innerText = `–£—Ä–æ–≤–µ–Ω—å ${this.level} –∑–∞–≤–µ—Ä—à–µ–Ω. –í–µ—Ç–µ—Ä: ${this.wind.toFixed(1)}`;
            },

            nextLevel() {
                this.level++;
                this.state = 'play';
                document.getElementById('shop-screen').classList.add('hidden');
                this.loadLevel();
            },

            buyUpgrade(type) {
                let u = this.upgrades[type];
                if (this.truck.money >= u.cost) {
                    if (type === 'nozzle' && u.active) return;
                    this.truck.money -= u.cost;
                    u.cost = Math.floor(u.cost * 1.5);
                    if (type === 'pressure') u.val += 2;
                    if (type === 'tank') { u.val += 50; this.truck.maxWater = u.val; this.truck.water = u.val; }
                    if (type === 'speed') u.val += 1;
                    if (type === 'nozzle') u.active = true;
                    
                    document.getElementById(`cost-${type}`).innerText = '$' + u.cost;
                    this.showFloat("OK!", W/2, H/2, "#0f0");
                }
            },

            gameOver() {
                this.state = 'over';
                document.getElementById('game-over-screen').classList.remove('hidden');
                document.getElementById('final-score').innerText = `$${Math.floor(this.truck.money)}`;
                vibrate(500);
            }
        };

        game.init();
    </script>
</body>
</html>
