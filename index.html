<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INFERNO: CHAOS EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap');

        :root {
            --bg: #020203;
            --ui: rgba(10, 15, 20, 0.9);
            --accent: #ff2a2a;
            --warn: #ffcc00;
            --hud: #00f2ff;
        }

        body {
            margin: 0; background: var(--bg); overflow: hidden;
            font-family: 'Chakra Petch', sans-serif;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* SCANLINES & VIGNETTE */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 10; pointer-events: none;
        }

        /* TOP HUD */
        .hud-top {
            display: flex; justify-content: space-between; padding: max(10px, env(safe-area-inset-top)) 15px 0 15px;
        }

        .widget {
            background: var(--ui); border: 1px solid rgba(255,255,255,0.15);
            padding: 5px 10px; transform: skewX(-15deg);
            border-left: 4px solid var(--hud);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .widget-in { transform: skewX(15deg); text-align: center; }
        
        .val { font-size: 18px; font-weight: 700; color: #fff; text-shadow: 0 0 5px var(--hud); }
        .lbl { font-size: 9px; color: #888; letter-spacing: 1px; }

        /* BARS */
        .bar-box { width: 80px; height: 6px; background: #222; margin-top: 4px; border: 1px solid #444; }
        .bar-f { height: 100%; width: 100%; transition: width 0.1s; }
        .f-wat { background: var(--hud); box-shadow: 0 0 8px var(--hud); }
        .f-ult { background: linear-gradient(90deg, #ff00aa, #aa00ff); }

        /* NOTIFICATIONS */
        .ticker {
            position: absolute; top: 80px; width: 100%; text-align: center;
            font-size: 20px; font-weight: 900; color: var(--warn);
            text-shadow: 0 2px 0 #000; opacity: 0; transition: 0.3s;
            transform: scale(0.8); pointer-events: none;
        }
        .ticker.active { opacity: 1; transform: scale(1); animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.5; } }

        /* CONTROLS */
        .ctrl-zone {
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            pointer-events: auto; display: flex; justify-content: space-between; align-items: flex-end;
        }

        .stick { position: relative; width: 140px; height: 140px; }

        .btn {
            position: absolute; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px); border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 24px; transition: 0.1s;
        }
        .btn:active { background: rgba(0, 242, 255, 0.2); border-color: var(--hud); }

        .b-l { left: 0; top: 50px; width: 60px; height: 60px; }
        .b-r { right: 0; top: 50px; width: 60px; height: 60px; }
        .b-refill { bottom: 0; left: 35px; width: 70px; height: 30px; font-size: 10px; border-color: var(--accent); color: var(--accent); }

        .b-u { left: 40px; top: 0; width: 60px; height: 50px; }
        .b-d { left: 40px; bottom: 0; width: 60px; height: 50px; }
        .b-shoot { 
            right: 0; top: 30px; width: 80px; height: 80px; border-radius: 50%;
            border: 2px solid var(--accent); background: rgba(255, 42, 42, 0.1);
            box-shadow: 0 0 20px rgba(255,0,0,0.3);
        }
        .b-shoot:active { background: rgba(255,0,0,0.5); transform: scale(0.95); }

        /* ULT BTN */
        .ult-btn {
            position: absolute; bottom: 160px; right: 20px; pointer-events: auto;
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid #f0a;
            background: #000; color: #f0a; display: flex; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold; opacity: 0.3; transition: 0.3s;
        }
        .ult-btn.ready { opacity: 1; box-shadow: 0 0 15px #f0a; animation: shake 2s infinite; cursor: pointer; }
        @keyframes shake { 0%,100%{transform:translate(0);} 5%{transform:translate(2px,0);} 10%{transform:translate(-2px,0);} }

        /* MENUS */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 100;
        }
        .modal.active { opacity: 1; pointer-events: auto; }

        .panel {
            width: 90%; max-width: 400px; background: #0a0b10;
            border: 1px solid #333; padding: 20px;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.1);
            position: relative; overflow: hidden;
        }
        .panel::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background: var(--hud); }

        h1 { margin: 0; font-size: 24px; color: #fff; text-transform: uppercase; }
        .sub { color: #666; font-size: 12px; margin-bottom: 20px; }

        /* TRUCK SELECTOR */
        .garage { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .truck-card {
            min-width: 100px; background: #15151a; border: 1px solid #333;
            padding: 10px; cursor: pointer; transition: 0.2s; opacity: 0.6;
        }
        .truck-card.selected { border-color: var(--hud); opacity: 1; background: rgba(0, 242, 255, 0.1); }
        .t-name { color: #fff; font-weight: bold; font-size: 12px; }
        .t-stat { font-size: 10px; color: #888; margin-top: 4px; }

        .btn-main {
            width: 100%; padding: 15px; background: var(--hud); border: none;
            color: #000; font-weight: 900; font-size: 16px; cursor: pointer;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn-main:active { filter: brightness(0.8); }

        /* FX TEXT */
        .float { position: absolute; font-weight: 900; font-size: 20px; animation: floatUp 1s forwards; pointer-events: none; text-shadow: 1px 1px 0 #000; }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
        
        .flash { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; pointer-events:none; opacity:0; transition:0.1s; z-index: 20;}

    </style>
</head>
<body>

    <div class="overlay"></div>
    <div id="flash" class="flash"></div>
    <canvas id="cvs"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="widget">
                <div class="widget-in">
                    <div class="lbl">WATER</div>
                    <div class="bar-box"><div class="bar-f f-wat" id="ui-wat"></div></div>
                </div>
            </div>
            <div class="widget">
                <div class="widget-in">
                    <div class="lbl">CAPITAL</div>
                    <div class="val" id="ui-cash">$0</div>
                </div>
            </div>
            <div class="widget" style="border-left-color: var(--accent);">
                <div class="widget-in">
                    <div class="lbl">DANGER</div>
                    <div class="bar-box"><div class="bar-f" style="background:var(--accent)" id="ui-heat"></div></div>
                </div>
            </div>
        </div>

        <div id="ticker" class="ticker">⚠️ DRONE SQUADRON DETECTED ⚠️</div>
        <div id="fx-box"></div>

        <div class="ult-btn" id="btn-ult" onclick="Game.ult()">
            HYDRO<br>NUKE
            <div style="position:absolute; bottom:-10px; width:100%; height:4px; background:#333;">
                <div class="bar-f f-ult" id="ui-ult-bar" style="width:0%"></div>
            </div>
        </div>

        <div class="ctrl-zone">
            <div class="stick">
                <div id="b-l" class="btn b-l">←</div>
                <div id="b-r" class="btn b-r">→</div>
                <div id="b-refill" class="btn b-refill">REFILL</div>
            </div>
            <div class="stick">
                <div id="b-u" class="btn b-u">↑</div>
                <div id="b-d" class="btn b-d">↓</div>
                <div id="b-shoot" class="btn b-shoot"></div>
            </div>
        </div>
    </div>

    <!-- GARAGE MENU -->
    <div id="menu" class="modal active">
        <div class="panel">
            <h1>GARAGE</h1>
            <div class="sub">SELECT YOUR VEHICLE</div>
            
            <div class="garage">
                <div class="truck-card selected" onclick="Game.selectTruck(0, this)">
                    <div class="t-name">VANGUARD</div>
                    <div class="t-stat">SPD: ●●○<br>TNK: ●●○<br>PWR: ●●○</div>
                </div>
                <div class="truck-card" onclick="Game.selectTruck(1, this)">
                    <div class="t-name">GOLIATH</div>
                    <div class="t-stat">SPD: ●○○<br>TNK: ●●●<br>PWR: ●●●</div>
                </div>
                <div class="truck-card" onclick="Game.selectTruck(2, this)">
                    <div class="t-name">STINGER</div>
                    <div class="t-stat">SPD: ●●●<br>TNK: ●○○<br>PWR: ●○○</div>
                </div>
            </div>

            <div class="sub" style="border:1px solid #333; padding:10px;">
                WARNING: Hostile drones detected in the sector. Use water cannon to neutralize them.
            </div>

            <button class="btn-main" onclick="Game.start()">DEPLOY</button>
        </div>
    </div>

    <!-- SHOP -->
    <div id="shop" class="modal">
        <div class="panel">
            <h1 style="color: #0f0;">MISSION ACCOMPLISHED</h1>
            <p id="shop-stats">...</p>
            <div id="upgrades"></div>
            <button class="btn-main" onclick="Game.next()">NEXT SECTOR</button>
        </div>
    </div>

    <script>
        // === ENGINE ===
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d', { alpha: false, desynchronized: true });
        
        let W, H, DPR;
        const resize = () => {
            W = window.innerWidth; H = window.innerHeight;
            DPR = Math.min(2, window.devicePixelRatio);
            cvs.width = W * DPR; cvs.height = H * DPR;
            ctx.scale(DPR, DPR);
        };
        window.addEventListener('resize', resize);
        resize();

        const rnd = (min, max) => Math.random() * (max - min) + min;
        const vibrate = (ms) => { if(navigator.vibrate) navigator.vibrate(ms); };

        // === ASSETS (DATA) ===
        const TRUCKS = [
            { name: 'VANGUARD', color: '#e22', speed: 4, tank: 100, power: 12, reload: 1 },
            { name: 'GOLIATH', color: '#444', speed: 2, tank: 200, power: 18, reload: 1.5 },
            { name: 'STINGER', color: '#ffcc00', speed: 7, tank: 60, power: 8, reload: 0.5 } // Fast fire
        ];

        // === OBJECT POOL ===
        // [x, y, vx, vy, type, life, size, r, g, b]
        const MAX_P = 3000;
        const P = new Float32Array(MAX_P * 10);
        let pIdx = 0;

        function spawn(x, y, type, vx, vy, size, col) {
            let i = pIdx * 10;
            P[i] = x; P[i+1] = y; P[i+2] = vx; P[i+3] = vy;
            P[i+4] = type; // 0:Wat, 1:Fire, 2:Smoke, 3:Spark, 4:Exp, 5:Debris
            P[i+5] = 1.0; // Life
            P[i+6] = size;
            // Color logic
            if(type===1) { P[i+7]=255; P[i+8]=rnd(50,150); P[i+9]=0; } // Fire
            else if(type===0) { P[i+7]=0; P[i+8]=240; P[i+9]=255; } // Water
            else if(type===4) { P[i+7]=255; P[i+8]=255; P[i+9]=255; } // Explosion
            else { P[i+7]=col?col[0]:200; P[i+8]=col?col[1]:200; P[i+9]=col?col[2]:200; }

            pIdx = (pIdx + 1) % MAX_P;
        }

        // === ENTITIES ===
        const Cam = { x: 0, shake: 0 };

        class Drone {
            constructor(x) {
                this.x = x; this.y = rnd(50, 150);
                this.vx = rnd(1, 3) * (Math.random()>0.5?1:-1);
                this.hp = 20;
                this.timer = rnd(100, 300);
            }
            update() {
                this.x += this.vx;
                if(this.x < 0 || this.x > Game.wWidth) this.vx *= -1;
                this.y += Math.sin(Date.now()/500)*0.5;

                // Drop Bomb
                this.timer--;
                if(this.timer <= 0) {
                    this.timer = rnd(200, 500);
                    Game.bombs.push({ x: this.x, y: this.y, vx: 0, vy: 0 });
                }
            }
            draw(ctx, cx) {
                let dx = this.x - cx;
                ctx.fillStyle = '#111';
                ctx.fillRect(dx-10, this.y-5, 20, 10);
                // Rotors
                ctx.fillStyle = '#444';
                let off = Math.sin(Date.now())*5;
                ctx.fillRect(dx-15, this.y-8+off, 10, 2);
                ctx.fillRect(dx+5, this.y-8-off, 10, 2);
                // Eye
                ctx.fillStyle = '#f00';
                ctx.fillRect(dx-2, this.y, 4, 4);
            }
        }

        class Building {
            constructor(x, w, h) {
                this.x = x; this.w = w; this.h = h;
                this.hp = 100; this.dead = false;
                this.windows = [];
                this.barrels = []; // TNT

                let rows = Math.floor(h/50);
                let cols = Math.floor(w/40);
                
                for(let r=0; r<rows; r++) {
                    for(let c=0; c<cols; c++) {
                        this.windows.push({
                            rx: 5+c*40, ry: 10+r*50, w: 30, h: 35,
                            fire: 0, max: 100, person: Math.random()<0.15, saved: false
                        });
                    }
                }

                // Add TNT
                if(Math.random() < 0.5) {
                    let r = Math.floor(Math.random() * rows);
                    let c = Math.floor(Math.random() * cols);
                    this.barrels.push({ rx: 10+c*40+10, ry: 10+r*50+30, hp: 10 });
                }
            }

            draw(ctx, cx, ground) {
                let bx = this.x - cx;
                if(bx < -200 || bx > W) return;

                // Structure
                ctx.fillStyle = this.dead ? '#111' : '#0a0a0c';
                let dh = this.dead ? this.h * 0.3 : this.h;
                ctx.fillRect(bx, ground-dh, this.w, dh);
                
                if(this.dead) {
                    // Draw rubble smoke
                    if(Math.random()<0.2) spawn(this.x+rnd(0,this.w), ground, 2, rnd(-1,1), -2, 20);
                    return;
                }

                // Windows
                this.windows.forEach(w => {
                    let wx = bx + w.rx;
                    let wy = ground - this.h + w.ry;
                    
                    if(w.fire > 0) {
                        ctx.fillStyle = `rgba(255, ${200-w.fire*2}, 0, ${w.fire/100})`;
                        ctx.fillRect(wx, wy, w.w, w.h);
                        if(Math.random() < w.fire/500) spawn(this.x+w.rx+15, ground-this.h+w.ry+15, 1, rnd(-2,2), -3, rnd(10,20));
                    } else {
                        ctx.fillStyle = '#151518';
                        ctx.fillRect(wx, wy, w.w, w.h);
                    }

                    // TNT
                    this.barrels.forEach(b => {
                         // Simple drawing for TNT barrel
                         let tx = bx + b.rx;
                         let ty = ground - this.h + b.ry;
                         if(Math.abs(tx - wx) < 20 && Math.abs(ty - wy) < 20) { // Approx pos
                             ctx.fillStyle = 'red';
                             ctx.fillRect(bx + b.rx - 5, ground - this.h + b.ry - 10, 10, 15);
                             ctx.fillStyle = 'yellow';
                             ctx.font = '8px monospace';
                             ctx.fillText('TNT', bx + b.rx - 8, ground - this.h + b.ry);
                         }
                    });

                    if(w.person && !w.saved) {
                        ctx.fillStyle = '#fff'; ctx.font='16px monospace';
                        ctx.fillText('웃', wx+5, wy+25);
                        if(w.fire>0) { ctx.fillStyle='#f00'; ctx.font='10px monospace'; ctx.fillText('SOS', wx, wy-2); }
                    }
                });
            }
        }

        // === GAME LOGIC ===
        const Game = {
            mode: 'menu', // menu, play, shop
            truckIdx: 0,
            stats: { money: 0, level: 1, ups: {spd:0, tnk:0, pmp:0} },
            truck: { x: 100, ang: -0.5, wat: 100, max: 100 },
            buildings: [],
            drones: [],
            bombs: [],
            ult: 0,
            heat: 0,
            wWidth: 3000,

            selectTruck(i, el) {
                this.truckIdx = i;
                document.querySelectorAll('.truck-card').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
            },

            start() {
                document.getElementById('menu').classList.remove('active');
                this.mode = 'play';
                this.loadLevel();
                Loop();
            },

            loadLevel() {
                this.buildings = []; this.drones = []; this.bombs = [];
                this.heat = 0; this.ult = 0;
                
                // Apply Truck Stats
                let proto = TRUCKS[this.truckIdx];
                this.truck.max = proto.tank + (this.stats.ups.tnk * 50);
                this.truck.wat = this.truck.max;
                this.truck.x = 100;

                // Gen City
                let bx = 200;
                for(let i=0; i<3+this.stats.level; i++) {
                    let w = rnd(120, 200);
                    this.buildings.push(new Building(bx, w, rnd(200, 400)));
                    bx += w + rnd(50, 100);
                }
                this.wWidth = bx + 500;

                // Initial Fires
                this.buildings.forEach(b => {
                    b.windows.forEach(w => { if(Math.random()<0.3) w.fire=40; });
                });

                // Spawn Drones (Level 2+)
                if(this.stats.level >= 2) {
                    for(let i=0; i<this.stats.level-1; i++) this.drones.push(new Drone(rnd(300, this.wWidth-300)));
                    document.getElementById('ticker').classList.add('active');
                } else {
                    document.getElementById('ticker').classList.remove('active');
                }
            },

            update() {
                let proto = TRUCKS[this.truckIdx];
                let spd = proto.speed + this.stats.ups.spd;
                
                // Controls
                if(In.l && this.truck.x > 50) this.truck.x -= spd;
                if(In.r && this.truck.x < this.wWidth - 50) this.truck.x += spd;
                if(In.u && this.truck.ang > -2) this.truck.ang -= 0.05;
                if(In.d && this.truck.ang < 0) this.truck.ang += 0.05;

                // Cam
                let tx = this.truck.x - W/2;
                if(Cam.shake > 0) { tx += rnd(-Cam.shake, Cam.shake); Cam.shake *= 0.9; }
                Cam.x += (tx - Cam.x) * 0.1;

                // Actions
                if(In.fil && this.truck.x < 200) this.truck.wat = Math.min(this.truck.max, this.truck.wat + 2);
                if(In.sht && this.truck.wat > 0) {
                    this.truck.wat -= proto.reload; // Consumption
                    let pow = proto.power + (this.stats.ups.pmp * 2);
                    // Muzzle pos
                    let mx = this.truck.x + 80; let my = H-60 - 40;
                    spawn(mx, my, 0, Math.cos(this.truck.ang)*pow, Math.sin(this.truck.ang)*pow, 5);
                    if(Math.random() > 0.7) vibrate(5);
                }

                // Entities
                this.drones.forEach(d => d.update());
                
                // Bombs
                for(let i=this.bombs.length-1; i>=0; i--) {
                    let b = this.bombs[i];
                    b.y += 3; // Gravity
                    if(b.y > H-60) { // Hit ground
                        // Explosion
                        this.explode(b.x, b.y, 30);
                        this.bombs.splice(i, 1);
                    }
                }

                // Particles & Physics
                for(let i=0; i<MAX_P*10; i+=10) {
                    if(P[i+5] <= 0) continue; // Dead
                    
                    P[i] += P[i+2]; P[i+1] += P[i+3]; // Move
                    P[i+5] -= 0.01; // Life

                    let type = P[i+4];
                    // Water Physics
                    if(type === 0) {
                        P[i+3] += 0.25; // Grav
                        if(P[i+1] > H-60) { P[i+5]=0; continue; } // Ground

                        // Check Collisions
                        // 1. Drones
                        this.drones.forEach((d, idx) => {
                            if(Math.abs(P[i] - d.x) < 20 && Math.abs(P[i+1] - d.y) < 10) {
                                d.hp--; P[i+5] = 0;
                                spawn(d.x, d.y, 3, rnd(-5,5), rnd(-5,5), 2); // Sparks
                                if(d.hp <= 0) {
                                    this.explode(d.x, d.y, 40);
                                    this.drones.splice(idx, 1);
                                    this.addCash(50, d.x, d.y);
                                }
                            }
                        });

                        // 2. Buildings
                        this.buildings.forEach(b => {
                            if(b.dead) return;
                            if(P[i] > b.x && P[i] < b.x+b.w) {
                                b.windows.forEach(w => {
                                    let wx = b.x + w.rx; let wy = H-60 - b.h + w.ry;
                                    if(Math.abs(P[i]-wx)<15 && Math.abs(P[i+1]-wy)<15) {
                                        if(w.fire > 0) {
                                            w.fire -= 2; P[i+5]=0;
                                            spawn(P[i], P[i+1], 2, 0, -2, 15); // Steam
                                            if(w.fire <= 0) {
                                                this.addCash(10, wx, wy);
                                                this.chargeUlt(2);
                                                if(w.person && !w.saved) {
                                                    w.saved = true;
                                                    this.addCash(100, wx, wy);
                                                }
                                            }
                                        }
                                        // Check TNT
                                        b.barrels.forEach((br, bIdx) => {
                                            // TNT doesn't like water (no effect, or maybe cools it?)
                                            // Ignored for now
                                        });
                                    }
                                });
                            }
                        });
                    }
                    // Explosion expanding
                    if(type === 4) {
                        P[i+6] *= 1.05; // Grow
                        P[i+5] -= 0.05; // Fast fade
                    }
                }

                // Building Logic & Fire Spread
                let activeFire = 0;
                this.buildings.forEach(b => {
                    if(b.dead) return;
                    b.windows.forEach(w => {
                        if(w.fire > 0) {
                            activeFire++;
                            w.fire += 0.05;
                            if(w.fire >= 100) {
                                w.fire = 100;
                                // Check TNT ignition
                                b.barrels.forEach((br, bIdx) => {
                                    // If fire is close to barrel
                                    let wx = w.rx, wy = w.ry;
                                    let dist = Math.hypot(wx - br.rx, wy - br.ry);
                                    if(dist < 40) {
                                        br.hp--;
                                        if(br.hp <= 0) {
                                            this.explode(b.x + br.rx, H-60-b.h+br.ry, 100);
                                            b.barrels.splice(bIdx, 1);
                                            b.dead = true; // Collapse
                                            Cam.shake = 30;
                                        }
                                    }
                                });
                            }
                        }
                    });
                });

                this.heat = Math.min(1000, this.heat + activeFire * 0.1);

                // Win Check
                if(activeFire === 0 && this.drones.length === 0 && pIdx > 0) {
                    setTimeout(() => this.win(), 1000);
                }
            },

            explode(x, y, rad) {
                vibrate(200);
                Cam.shake += 10;
                // Visuals
                spawn(x, y, 4, 0, 0, rad); // Boom circle
                for(let k=0; k<20; k++) spawn(x, y, 1, rnd(-5,5), rnd(-5,5), rnd(10,30)); // Fire chunks
                
                // Physics Knockback on Truck
                let dist = x - this.truck.x;
                if(Math.abs(dist) < rad + 50) {
                    this.truck.x -= (100 - Math.abs(dist)) * Math.sign(dist) * 0.5;
                }

                // Set fire to nearby
                this.buildings.forEach(b => {
                    if(x > b.x && x < b.x+b.w) {
                         b.windows.forEach(w => {
                             let wy = H-60 - b.h + w.ry;
                             if(Math.abs(y - wy) < rad) w.fire = 100;
                         });
                    }
                });
            },

            ult() {
                if(this.ult < 100) return;
                this.ult = 0;
                document.getElementById('btn-ult').classList.remove('ready');
                
                // Rain Nuke
                document.getElementById('flash').style.opacity = 1;
                setTimeout(() => document.getElementById('flash').style.opacity = 0, 100);
                
                for(let i=0; i<1000; i++) {
                    spawn(rnd(Cam.x, Cam.x+W), 0, 0, 0, rnd(10,20), 5);
                }
                // Damage all
                this.buildings.forEach(b => b.windows.forEach(w => w.fire = 0));
                this.drones.forEach(d => { this.explode(d.x, d.y, 30); d.hp=0; });
                this.drones = [];
            },

            addCash(amt, x, y) {
                this.stats.money += amt;
                UI.float(`+$${amt}`, x - Cam.x, y);
            },

            chargeUlt(amt) {
                this.ult = Math.min(100, this.ult + amt);
                document.getElementById('ui-ult-bar').style.width = this.ult + '%';
                if(this.ult >= 100) document.getElementById('btn-ult').classList.add('ready');
            },

            draw() {
                // Clear
                ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H);
                
                // Heat Haze (Simple shake of background elements)
                let shakeX = Math.random()* (this.heat/500);
                
                // Stars
                ctx.fillStyle = '#fff';
                for(let i=0;i<50;i++) ctx.fillRect((i*80 - Cam.x*0.2)%W, (i*97)%H, 1, 1);

                // Ground
                ctx.fillStyle = '#1a1a20';
                ctx.fillRect(0, H-60, W, 60);

                let groundY = H-60;
                
                // Hydrant
                let hx = 100 - Cam.x;
                if(hx > -50 && hx < W) { ctx.fillStyle='#f00'; ctx.fillRect(hx, groundY-20, 15, 20); }

                this.buildings.forEach(b => b.draw(ctx, Cam.x + shakeX, groundY));
                this.drones.forEach(d => d.draw(ctx, Cam.x));

                // Truck
                let tx = this.truck.x - Cam.x;
                let proto = TRUCKS[this.truckIdx];
                
                ctx.fillStyle = proto.color;
                ctx.fillRect(tx, groundY-40, 120, 30);
                // Cannon
                ctx.save(); ctx.translate(tx+80, groundY-40); ctx.rotate(this.truck.ang);
                ctx.fillStyle='#888'; ctx.fillRect(0, -5, 40, 10); ctx.restore();
                // Wheels
                ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(tx+30, groundY-10, 12, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(tx+90, groundY-10, 12, 0, 7); ctx.fill();

                // Particles
                for(let i=0; i<MAX_P*10; i+=10) {
                    if(P[i+5] <= 0) continue;
                    let px = P[i] - Cam.x;
                    if(px < -50 || px > W+50) continue;

                    let type = P[i+4];
                    if(type === 1) ctx.globalCompositeOperation = 'lighter'; // Fire glow
                    
                    ctx.fillStyle = `rgba(${P[i+7]},${P[i+8]},${P[i+9]},${P[i+5]})`;
                    ctx.beginPath(); ctx.arc(px, P[i+1], P[i+6], 0, 7); ctx.fill();
                    
                    ctx.globalCompositeOperation = 'source-over';
                }

                // Update UI
                document.getElementById('ui-wat').style.width = (this.truck.wat / this.truck.max * 100) + '%';
                document.getElementById('ui-heat').style.width = (this.heat / 1000 * 100) + '%';
                document.getElementById('ui-cash').innerText = '$' + this.stats.money;
            },

            win() {
                this.mode = 'shop';
                document.getElementById('shop').classList.add('active');
                this.renderShop();
                this.stats.level++;
            },
            next() {
                document.getElementById('shop').classList.remove('active');
                this.start();
            },
            renderShop() {
                let c = document.getElementById('upgrades');
                c.innerHTML = '';
                ['spd', 'tnk', 'pmp'].forEach(k => {
                    let cost = 200 + (this.stats.ups[k] * 100);
                    c.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:10px; background:#222; margin-bottom:5px; border:1px solid #444;" onclick="Game.buy('${k}', ${cost})">
                        <div style="color:#fff">UPGRADE ${k.toUpperCase()}</div>
                        <div style="color:${this.stats.money>=cost?'#0f0':'#f00'}">$${cost}</div>
                    </div>`;
                });
            },
            buy(k, cost) {
                if(this.stats.money >= cost) {
                    this.stats.money -= cost;
                    this.stats.ups[k]++;
                    this.renderShop();
                }
            }
        };

        // === INPUT ===
        const In = { l:0, r:0, u:0, d:0, sht:0, fil:0 };
        const bind = (id, k) => {
            let el = document.getElementById(id);
            let h = (s) => (e) => { e.preventDefault(); In[k] = s; if(s) el.style.opacity=0.5; else el.style.opacity=1; };
            el.addEventListener('touchstart', h(1)); el.addEventListener('touchend', h(0));
            el.addEventListener('mousedown', h(1)); el.addEventListener('mouseup', h(0));
        };
        bind('b-l','l'); bind('b-r','r'); bind('b-u','u'); bind('b-d','d');
        bind('b-shoot','sht'); bind('b-refill','fil');

        const UI = {
            float(t, x, y, c='#fff') {
                let d = document.createElement('div'); d.className='float';
                d.innerText=t; d.style.left=x+'px'; d.style.top=y+'px'; d.style.color=c;
                document.getElementById('fx-box').appendChild(d);
                setTimeout(()=>d.remove(), 900);
            }
        };

        function Loop() {
            if(Game.mode === 'play') {
                requestAnimationFrame(Loop);
                Game.update();
                Game.draw();
            }
        }

    </script>
</body>
</html>
