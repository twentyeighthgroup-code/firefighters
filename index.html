<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INFERNO: DIRECTOR'S CUT</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');

        :root {
            --c-bg: #050505;
            --c-ui: rgba(10, 12, 16, 0.85);
            --c-accent: #ff3333;
            --c-water: #00eeff;
            --c-gold: #ffcc00;
        }

        body {
            margin: 0; background: var(--c-bg); overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* GLITCH EFFECT & UI WRAPPER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: space-between; z-index: 10;
            text-shadow: 0 2px 0 #000;
        }

        /* HUD TOP */
        .hud-row {
            display: flex; justify-content: space-between; padding: max(10px, env(safe-area-inset-top)) 20px 0 20px;
        }

        .badge {
            background: var(--c-ui); border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 12px; border-radius: 6px; backdrop-filter: blur(4px);
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .b-label { font-size: 9px; color: #888; letter-spacing: 1px; margin-bottom: 2px; }
        .b-val { font-size: 16px; font-weight: 800; color: #fff; }
        .b-val.money { color: var(--c-gold); text-shadow: 0 0 10px rgba(255, 204, 0, 0.4); }
        
        .combo-box {
            transform: skewX(-10deg); border-color: var(--c-gold);
            transition: transform 0.1s;
        }
        .combo-active { transform: skewX(-10deg) scale(1.2); border-color: #fff; background: rgba(255,204,0,0.2); }

        /* BARS */
        .bar-cnt { width: 100%; height: 4px; background: #333; margin-top: 4px; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.1s; }
        .f-wat { background: var(--c-water); box-shadow: 0 0 8px var(--c-water); }
        .f-ult { background: linear-gradient(90deg, #ff00cc, #3333ff); width: 0%; transition: 0.1s; }

        /* CONTROLS */
        .ctrl-area {
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            pointer-events: auto; display: flex; justify-content: space-between; align-items: flex-end;
        }

        .stick { position: relative; width: 140px; height: 140px; }

        .btn {
            position: absolute; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 20px; transition: 0.05s;
            backdrop-filter: blur(5px);
        }
        .btn:active, .btn.down { background: rgba(255,255,255,0.2); transform: scale(0.95); border-color: #fff; }

        /* Specific Buttons */
        .b-l { left: 0; top: 50px; width: 60px; height: 60px; }
        .b-r { right: 0; top: 50px; width: 60px; height: 60px; }
        .b-refill { bottom: 0; left: 35px; width: 70px; height: 30px; font-size: 10px; border-color: var(--c-accent); color: var(--c-accent); }

        .b-u { left: 40px; top: 0; width: 60px; height: 50px; }
        .b-d { left: 40px; bottom: 0; width: 60px; height: 50px; }
        .b-shoot { 
            right: 0; top: 30px; width: 80px; height: 80px; 
            border-radius: 50%; border-color: var(--c-accent);
            background: rgba(255, 51, 51, 0.1);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
        }
        .b-shoot:active { background: rgba(255, 51, 51, 0.4); }

        /* ULTIMATE BUTTON */
        .ult-wrapper {
            position: absolute; bottom: 160px; right: 20px;
            width: 60px; height: 60px; pointer-events: auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .btn-ult {
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid #ff00cc; background: rgba(0,0,0,0.5);
            color: #ff00cc; font-weight: bold; font-size: 12px;
            box-shadow: 0 0 15px #ff00cc; opacity: 0.5; pointer-events: none;
            transition: 0.3s; display: flex; justify-content: center; align-items: center; text-align: center;
        }
        .btn-ult.ready { opacity: 1; pointer-events: auto; background: rgba(255, 0, 204, 0.2); animation: pulse 1s infinite; cursor: pointer; }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 100;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .panel {
            width: 85%; max-width: 400px;
            background: #0e0e12; border: 1px solid #333;
            padding: 30px; border-radius: 4px; text-align: center;
            position: relative; overflow: hidden;
        }
        /* Cyberpunk lines */
        .panel::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background: var(--c-accent); }
        .panel::after { content:''; position: absolute; bottom:0; right:0; width:20px; height:20px; border-right:2px solid var(--c-accent); border-bottom:2px solid var(--c-accent); }

        h1 { margin: 0; color: #fff; font-size: 28px; letter-spacing: -1px; }
        p { color: #888; font-size: 12px; margin-bottom: 20px; line-height: 1.4; }

        .main-btn {
            width: 100%; padding: 15px; background: #fff; color: #000;
            border: none; font-weight: 900; font-size: 16px; cursor: pointer;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 95% 100%, 0 100%);
            transition: 0.2s;
        }
        .main-btn:active { transform: scale(0.98); background: var(--c-gold); }

        /* UPGRADES GRID */
        .upg-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border: 1px solid #222; margin-bottom: 8px;
            background: rgba(255,255,255,0.02); cursor: pointer;
        }
        .upg-row:active { background: rgba(255,255,255,0.08); }
        
        /* FX LAYERS */
        .flash {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #fff; opacity:0; pointer-events:none; transition: opacity 0.1s; z-index: 20;
        }
        .lightning {
            background: #fff; opacity: 0; transition: opacity 0.05s;
        }
        .aberration {
            animation: glitch 0.2s linear;
        }
        @keyframes glitch { 
            0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); filter: hue-rotate(90deg); } 
            40% { transform: translate(2px, -2px); } 100% { transform: translate(0); }
        }

        .float-txt {
            position: absolute; font-weight: 900; font-size: 24px;
            text-shadow: 2px 2px 0 #000; pointer-events: none;
            animation: float 0.8s ease-out forwards;
        }
        @keyframes float { to { transform: translateY(-60px); opacity: 0; } }

    </style>
</head>
<body>

    <div id="flash-layer" class="flash"></div>
    <canvas id="game"></canvas>

    <div id="ui-layer">
        <div class="hud-row">
            <div class="badge">
                <div class="b-label">TANK</div>
                <div class="bar-cnt" style="width: 60px;"><div class="bar-fill f-wat" id="ui-water"></div></div>
            </div>
            
            <div class="badge combo-box" id="combo-ui">
                <div class="b-label">COMBO</div>
                <div class="b-val" style="color:var(--c-gold)" id="ui-combo">x1.0</div>
            </div>

            <div class="badge">
                <div class="b-label">CREDITS</div>
                <div class="b-val money" id="ui-money">$0</div>
            </div>
        </div>

        <div id="fx-container"></div>

        <div class="ult-wrapper">
            <div class="btn-ult" id="btn-ult" onclick="Game.useUlt()">
                HYDRO<br>BOMB
            </div>
            <div class="bar-cnt" style="margin-top:5px; width: 100%; border:1px solid #444;">
                <div class="bar-fill f-ult" id="ui-ult"></div>
            </div>
        </div>

        <div class="ctrl-area">
            <div class="stick">
                <div id="b-l" class="btn b-l">←</div>
                <div id="b-r" class="btn b-r">→</div>
                <div id="b-refill" class="btn b-refill">REFILL</div>
            </div>
            <div class="stick">
                <div id="b-u" class="btn b-u">↑</div>
                <div id="b-d" class="btn b-d">↓</div>
                <div id="b-shoot" class="btn b-shoot"></div>
            </div>
        </div>
    </div>

    <!-- SCREENS -->
    <div id="modal-start" class="modal-overlay active">
        <div class="panel">
            <h1 style="color:var(--c-accent)">INFERNO</h1>
            <p>DIRECTOR'S CUT</p>
            <div style="text-align:left; margin-bottom:20px; font-size:11px; color:#666; border:1px solid #333; padding:10px;">
                > WEATHER SYSTEM: ONLINE<br>
                > STRUCTURAL INTEGRITY: ACTIVE<br>
                > HYDRO-BOMB: CHARGING...
            </div>
            <button class="main-btn" onclick="Game.start()">INITIATE</button>
        </div>
    </div>

    <div id="modal-shop" class="modal-overlay">
        <div class="panel">
            <h1 style="color:var(--c-gold)">SUCCESS</h1>
            <p id="shop-msg">AREA SECURED</p>
            
            <div id="upgrades-list">
                <!-- Generated via JS -->
            </div>

            <button class="main-btn" onclick="Game.nextLevel()">NEXT MISSION</button>
        </div>
    </div>

    <script>
        // === ENGINE CORE ===
        const cvs = document.getElementById('game');
        const ctx = cvs.getContext('2d', { alpha: false, desynchronized: true });

        // RESIZE
        let W, H, DPR;
        const resize = () => {
            W = window.innerWidth; H = window.innerHeight;
            DPR = Math.min(2, window.devicePixelRatio);
            cvs.width = W * DPR; cvs.height = H * DPR;
            ctx.scale(DPR, DPR);
        };
        window.addEventListener('resize', resize);
        resize();

        // UTILS
        const rnd = (min, max) => Math.random() * (max - min) + min;
        const vibrate = (p) => { if(navigator.vibrate) navigator.vibrate(p); };
        
        // === PARTICLES (Typed Array Pool for Max Performance) ===
        const MAX_P = 2500;
        // Data layout: [x, y, vx, vy, type, life, size]
        const P_DATA = new Float32Array(MAX_P * 7); 
        let p_count = 0;

        function spawnP(x, y, type, vx, vy, size) {
            if (p_count >= MAX_P) return;
            const i = p_count * 7;
            P_DATA[i] = x; P_DATA[i+1] = y;
            P_DATA[i+2] = vx; P_DATA[i+3] = vy;
            P_DATA[i+4] = type; // 0:Water, 1:Fire, 2:Smoke, 3:Spark, 4:Rain, 5:Debris
            P_DATA[i+5] = 1.0; // Life
            P_DATA[i+6] = size;
            p_count++;
        }

        // === GAME CLASSES ===
        const Camera = { x: 0, y: 0, shake: 0 };

        class Building {
            constructor(x, w, h) {
                this.x = x; this.w = w; this.h = h;
                this.integrity = 100; // Collapse mechanic
                this.collapsed = false;
                this.windows = [];
                
                let rows = Math.floor(h/60);
                let cols = Math.floor(w/40);
                for(let r=0; r<rows; r++) {
                    for(let c=0; c<cols; c++) {
                        this.windows.push({
                            rx: 10+c*40, ry: 10+r*60,
                            w: 25, h: 40,
                            hp: 0, max: 100,
                            person: Math.random() < 0.2,
                            saved: false
                        });
                    }
                }
            }
            
            update() {
                if(this.collapsed) {
                    this.h = Math.max(10, this.h * 0.95); // Sink animation
                    return;
                }
                
                // Calculate structural damage based on total fire
                let fireSum = 0;
                this.windows.forEach(w => fireSum += w.hp);
                if(fireSum > 500) {
                    this.integrity -= 0.1;
                    if(this.integrity <= 0) this.collapse();
                }
            }

            collapse() {
                this.collapsed = true;
                Camera.shake = 30;
                vibrate(500);
                UI.flash();
                UI.float("COLLAPSE!", this.x - Camera.x + this.w/2, H/2, '#f00');
                // Spawn massive dust
                for(let i=0; i<50; i++) {
                    spawnP(this.x + rnd(0, this.w), H, 2, rnd(-5,5), rnd(-2,-10), rnd(20,50));
                }
            }

            draw(ctx, groundY) {
                let bx = this.x - Camera.x;
                if(bx < -200 || bx > W) return;

                // Building
                ctx.fillStyle = this.collapsed ? '#111' : '#08080a';
                let drawH = this.collapsed ? this.h : this.h + (Math.random() * (100-this.integrity)*0.05); // Shake effect if unstable
                ctx.fillRect(bx, groundY - drawH, this.w, drawH);
                
                // Integrity Bar
                if(this.integrity < 90 && !this.collapsed) {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(bx, groundY - drawH - 10, this.w * (this.integrity/100), 4);
                }

                if(this.collapsed) return;

                this.windows.forEach(w => {
                    let wx = bx + w.rx;
                    let wy = groundY - this.h + w.ry;
                    
                    if(w.hp > 0) {
                        // Additive fire
                        ctx.fillStyle = `rgba(255, ${rnd(100,200)}, 0, ${w.hp/100})`;
                        ctx.fillRect(wx, wy, w.w, w.h);
                        // Spawn fire particles
                        if(Math.random() < w.hp/400) {
                            spawnP(wx+w.w/2, wy+w.h/2, 1, rnd(-1,1), rnd(-1,-3), rnd(10,20));
                        }
                    } else {
                        ctx.fillStyle = '#111';
                        ctx.fillRect(wx, wy, w.w, w.h);
                    }

                    if(w.person && !w.saved) {
                        ctx.fillStyle = '#fff';
                        ctx.font = '20px monospace';
                        ctx.fillText('웃', wx+2, wy+30);
                        if(w.hp>0) {
                            ctx.fillStyle = '#f00';
                            ctx.font = '10px monospace';
                            ctx.fillText('SOS', wx, wy-5);
                        }
                    }
                });
            }
        }

        // === GAME LOGIC ===
        const Game = {
            active: false,
            buildings: [],
            truck: { x: 100, angle: -0.5, water: 100, maxWater: 100 },
            stats: { money: 0, level: 1, upgrades: {pump:1, tank:1, speed:1}, ult: 0 },
            combo: { val: 1, timer: 0 },
            weather: { rain: 0, storm: false },
            groundY: 0,

            start() {
                document.querySelector('.active').classList.remove('active');
                this.groundY = H - 60;
                this.active = true;
                this.loadLevel();
                Loop();
            },

            loadLevel() {
                this.buildings = [];
                this.truck.water = this.truck.maxWater;
                this.truck.x = 100;
                this.stats.ult = 0;
                
                // Dynamic Weather
                this.weather.rain = (this.stats.level > 1) ? 1 : 0;
                this.weather.storm = (this.stats.level > 3 && Math.random()>0.5);

                // Generate
                let bx = 250;
                for(let i=0; i< 2 + this.stats.level; i++) {
                    let w = rnd(100, 200);
                    let h = rnd(200, 400);
                    this.buildings.push(new Building(bx, w, h));
                    bx += w + rnd(50, 100);
                }

                // Ignite
                this.buildings.forEach(b => {
                    let wins = b.windows.filter(() => Math.random()<0.4);
                    wins.forEach(w => w.hp = 50);
                });
            },

            update() {
                // Weather logic
                if(this.weather.rain) {
                    if(Math.random() > 0.5) spawnP(rnd(Camera.x, Camera.x+W), 0, 4, 1, 15, rnd(20,40)); // Rain drops
                    if(this.weather.storm && Math.random() < 0.005) {
                        UI.flash(true); // Lightning
                        vibrate(100);
                    }
                }

                // Combo decay
                if(this.combo.val > 1) {
                    this.combo.timer--;
                    if(this.combo.timer <= 0) {
                        this.combo.val = 1;
                        UI.updateCombo();
                    }
                }

                // Truck
                let speed = 3 + this.stats.upgrades.speed;
                if(In.l && this.truck.x > 0) this.truck.x -= speed;
                if(In.r && this.truck.x < 3000) this.truck.x += speed;
                if(In.u && this.truck.angle > -2) this.truck.angle -= 0.05;
                if(In.d && this.truck.angle < 0) this.truck.angle += 0.05;

                // Camera
                let targetX = this.truck.x - W/2 + 60;
                Camera.x += (targetX - Camera.x) * 0.1;
                if(Camera.shake > 0) {
                    Camera.x += rnd(-Camera.shake, Camera.shake);
                    Camera.shake *= 0.9;
                    if(Camera.shake < 0.5) Camera.shake = 0;
                }

                // Shooting
                if(In.refill && this.truck.x < 200) this.truck.water = Math.min(this.truck.maxWater, this.truck.water + 2);
                
                if(In.shoot && this.truck.water > 0) {
                    this.truck.water -= 0.3;
                    let pow = 12 + this.stats.upgrades.pump * 2;
                    spawnP(this.truck.x + 80, this.groundY - 50, 0, 
                        Math.cos(this.truck.angle)*pow, 
                        Math.sin(this.truck.angle)*pow, 
                        4
                    );
                }

                // Particles Update
                let activeP = 0;
                for(let i=0; i<p_count; i++) {
                    let idx = i * 7;
                    if(P_DATA[idx+5] <= 0) continue; // Dead

                    // Update Pos
                    P_DATA[idx] += P_DATA[idx+2]; // x + vx
                    P_DATA[idx+1] += P_DATA[idx+3]; // y + vy
                    P_DATA[idx+5] -= 0.015; // Life decay

                    let type = P_DATA[idx+4];

                    // Physics
                    if(type === 0) { // Water
                        P_DATA[idx+3] += 0.25; // Gravity
                        
                        // Collision
                        if(P_DATA[idx+1] > this.groundY) { P_DATA[idx+5] = 0; continue; } // Ground
                        
                        // Building Collision
                        for(let b of this.buildings) {
                            if(b.collapsed) continue;
                            if(P_DATA[idx] > b.x && P_DATA[idx] < b.x + b.w) {
                                for(let w of b.windows) {
                                    let wx = b.x + w.rx; 
                                    let wy = this.groundY - b.h + w.ry;
                                    // AABB Collision
                                    if(P_DATA[idx] > wx && P_DATA[idx] < wx+w.w && P_DATA[idx+1] > wy && P_DATA[idx+1] < wy+w.h) {
                                        if(w.hp > 0) {
                                            P_DATA[idx+5] = 0; // Kill water
                                            w.hp -= 2;
                                            spawnP(P_DATA[idx], P_DATA[idx+1], 2, 0, -2, 15); // Steam
                                            
                                            if(w.hp <= 0) this.onExtinguish(w, wx, wy);
                                        }
                                    }
                                }
                            }
                        }
                    } else if (type === 4) { // Rain
                        P_DATA[idx+3] += 0.1;
                        if(P_DATA[idx+1] > this.groundY) P_DATA[idx+5] = 0;
                        // Rain reduces fire slightly
                        if(Math.random() < 0.05) {
                             for(let b of this.buildings) {
                                 if(!b.collapsed) b.windows.forEach(w => { if(w.hp>0) w.hp-=0.1; });
                             }
                        }
                    }
                    
                    // Swap Remove (Optimization)
                    if(P_DATA[idx+5] <= 0) {
                        let last = (p_count - 1) * 7;
                        for(let k=0; k<7; k++) P_DATA[idx+k] = P_DATA[last+k];
                        p_count--;
                        i--; 
                    }
                }

                // Buildings
                let burningCount = 0;
                this.buildings.forEach(b => {
                    b.update();
                    if(!b.collapsed) b.windows.forEach(w => {
                         if(w.hp > 0) {
                             burningCount++;
                             w.hp += 0.05 + (this.stats.level * 0.01);
                             if(w.hp > 100) w.hp = 100;
                         }
                    });
                });

                // Win check
                if(burningCount === 0 && p_count < 10) {
                    if(!this.winT) this.winT = setTimeout(()=>this.win(), 1000);
                } else this.winT = null;
            },

            onExtinguish(w, x, y) {
                // Combo Logic
                this.combo.val = Math.min(this.combo.val + 0.5, 4.0);
                this.combo.timer = 120; // 2 seconds
                UI.updateCombo();

                // Money
                let amount = Math.floor(15 * this.combo.val);
                this.stats.money += amount;
                UI.float(`+$${amount}`, x - Camera.x, y, '#ffcc00');

                // Charge Ult
                this.stats.ult = Math.min(100, this.stats.ult + 5);
                document.getElementById('ui-ult').style.width = this.stats.ult + '%';
                if(this.stats.ult >= 100) document.getElementById('btn-ult').classList.add('ready');

                // Save Person
                if(w.person && !w.saved) {
                    w.saved = true;
                    this.hitStop(50); // Cinematic freeze
                    this.stats.money += 100;
                    UI.float("SAVED!", x - Camera.x, y - 20, '#0f0');
                }
            },

            useUlt() {
                if(this.stats.ult < 100) return;
                this.stats.ult = 0;
                document.getElementById('ui-ult').style.width = '0%';
                document.getElementById('btn-ult').classList.remove('ready');
                
                // FX
                UI.flash();
                Camera.shake = 20;
                vibrate(300);
                
                // Spawn MASSIVE water wave
                for(let i=0; i<300; i++) {
                    spawnP(this.truck.x + 80, this.groundY - 50, 0, rnd(-10, 20), rnd(-15, 5), 6);
                }
                
                // Kill all fires on screen
                this.buildings.forEach(b => {
                    if(!b.collapsed) b.windows.forEach(w => w.hp = 0);
                });
            },

            hitStop(ms) {
                // Simple loop pause simulation could go here, usually just skpping an update frame or two
            },

            draw() {
                // Sky
                ctx.fillStyle = this.weather.storm ? '#111' : '#050508';
                ctx.fillRect(0, 0, W, H);

                // Ground
                ctx.fillStyle = '#1a1a20';
                ctx.fillRect(0, this.groundY, W, H - this.groundY);
                
                // Hydrant
                let hx = 100 - Camera.x;
                if(hx > -50 && hx < W) {
                    ctx.fillStyle = '#f33';
                    ctx.fillRect(hx, this.groundY - 20, 15, 20);
                }

                // Buildings
                this.buildings.forEach(b => b.draw(ctx, this.groundY));

                // Truck
                let tx = this.truck.x - Camera.x;
                // Headlights
                ctx.fillStyle = 'rgba(255, 255, 200, 0.1)';
                ctx.beginPath(); ctx.moveTo(tx+130, this.groundY-45);
                ctx.lineTo(tx+400, this.groundY); ctx.lineTo(tx+130, this.groundY);
                ctx.fill();

                ctx.fillStyle = '#e22';
                ctx.fillRect(tx, this.groundY - 45, 130, 35);
                // Cannon
                ctx.save(); ctx.translate(tx+80, this.groundY-45); ctx.rotate(this.truck.angle);
                ctx.fillStyle='#888'; ctx.fillRect(0,-5,40,10); ctx.restore();
                // Wheels
                ctx.fillStyle='#111'; 
                ctx.beginPath(); ctx.arc(tx+30, this.groundY-10, 12, 0, 6.28); ctx.fill();
                ctx.beginPath(); ctx.arc(tx+100, this.groundY-10, 12, 0, 6.28); ctx.fill();

                // Particles Render
                for(let i=0; i<p_count; i++) {
                    let idx = i*7;
                    if(P_DATA[idx+5] <= 0) continue;
                    
                    let px = P_DATA[idx] - Camera.x;
                    let py = P_DATA[idx+1];
                    let type = P_DATA[idx+4];
                    let sz = P_DATA[idx+6];

                    if(type === 0) { // Water
                        ctx.fillStyle = '#0ef';
                        ctx.globalAlpha = 0.8;
                    } else if (type === 1) { // Fire
                        ctx.globalCompositeOperation = 'lighter';
                        ctx.fillStyle = `rgba(255, ${rnd(100,200)}, 0, ${P_DATA[idx+5]})`;
                    } else if (type === 2) { // Smoke
                        ctx.fillStyle = '#222'; ctx.globalAlpha = 0.5;
                    } else if (type === 4) { // Rain
                        ctx.strokeStyle = '#5577aa'; ctx.lineWidth = 2; ctx.globalAlpha = 0.5;
                        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px-2, py+15); ctx.stroke();
                        continue;
                    }

                    if(type !== 4) {
                        ctx.beginPath(); ctx.arc(px, py, sz, 0, 6.28); ctx.fill();
                    }
                    ctx.globalAlpha = 1; ctx.globalCompositeOperation = 'source-over';
                }

                // Update UI
                document.getElementById('ui-water').style.width = this.truck.water + '%';
                document.getElementById('ui-money').innerText = '$' + this.stats.money;
            },
            
            win() {
                this.active = false;
                this.stats.level++;
                document.getElementById('modal-shop').classList.add('active');
                this.updateShop();
            },
            
            nextLevel() {
                document.getElementById('modal-shop').classList.remove('active');
                this.start();
            },

            buy(type) {
                let cost = 200 * this.stats.upgrades[type];
                if(this.stats.money >= cost) {
                    this.stats.money -= cost;
                    this.stats.upgrades[type]++;
                    this.updateShop();
                }
            },
            
            updateShop() {
                let list = document.getElementById('upgrades-list');
                list.innerHTML = '';
                ['pump', 'tank', 'speed'].forEach(k => {
                    let cost = 200 * this.stats.upgrades[k];
                    list.innerHTML += `
                    <div class="upg-row" onclick="Game.buy('${k}')">
                        <div>
                            <div style="color:#fff; font-size:14px; font-weight:bold;">UPGRADE ${k.toUpperCase()}</div>
                            <div style="color:#666; font-size:10px;">Level ${this.stats.upgrades[k]}</div>
                        </div>
                        <div style="color:var(--c-gold); font-weight:bold;">$${cost}</div>
                    </div>`;
                });
            }
        };

        // === INPUT & UI ===
        const In = { l:0, r:0, u:0, d:0, shoot:0, refill:0 };
        const bind = (id, k) => {
            const el = document.getElementById(id);
            const fn = (s) => (e) => { e.preventDefault(); In[k]=s; el.classList.toggle('down', s); };
            el.addEventListener('touchstart', fn(1)); el.addEventListener('touchend', fn(0));
            el.addEventListener('mousedown', fn(1)); el.addEventListener('mouseup', fn(0));
        };
        bind('b-l','l'); bind('b-r','r'); bind('b-u','u'); bind('b-d','d');
        bind('b-shoot','shoot'); bind('b-refill','refill');

        const UI = {
            flash(lightning=false) {
                const f = document.getElementById('flash-layer');
                f.className = lightning ? 'flash lightning' : 'flash';
                f.style.opacity = 0.8;
                setTimeout(() => f.style.opacity = 0, 50);
            },
            float(txt, x, y, col) {
                let el = document.createElement('div');
                el.className = 'float-txt';
                el.innerText = txt;
                el.style.left = x+'px'; el.style.top = y+'px'; el.style.color = col;
                document.getElementById('fx-container').appendChild(el);
                setTimeout(() => el.remove(), 800);
            },
            updateCombo() {
                let el = document.getElementById('ui-combo');
                el.innerText = 'x' + Game.combo.val.toFixed(1);
                let box = document.getElementById('combo-ui');
                if(Game.combo.val > 1) box.classList.add('combo-active');
                else box.classList.remove('combo-active');
            }
        };

        function Loop() {
            if(Game.active) {
                requestAnimationFrame(Loop);
                Game.update();
                Game.draw();
            }
        }

    </script>
</body>
</html>
