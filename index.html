<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üî• INFERNO CITY: LEGENDS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@600;700&display=swap');

        :root {
            --bg: #050508;
            --ui-bg: rgba(10, 15, 25, 0.85);
            --neon-blue: #00f3ff;
            --neon-red: #ff2a2a;
            --neon-gold: #ffd700;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            margin: 0;
            background-color: var(--bg);
            overflow: hidden;
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            image-rendering: optimizeSpeed; /* –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */
        }

        /* UI OVERLAY */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        /* HUD */
        .hud-top {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            padding-top: max(10px, env(safe-area-inset-top));
        }

        .hud-panel {
            background: var(--ui-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 8px 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            min-width: 80px;
            text-align: center;
        }

        .label { font-size: 10px; color: #889; text-transform: uppercase; letter-spacing: 1px; }
        .value { font-family: 'Orbitron', sans-serif; font-size: 18px; color: #fff; text-shadow: 0 0 10px var(--neon-blue); }
        .value.money { color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold); }

        /* Bar Styles */
        .bar-wrap {
            width: 100%; height: 4px; background: #222; margin-top: 4px; border-radius: 2px; overflow: hidden;
        }
        .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        #water-fill { background: var(--neon-blue); box-shadow: 0 0 8px var(--neon-blue); }
        #heat-fill { background: var(--neon-red); box-shadow: 0 0 8px var(--neon-red); }

        /* CONTROLS */
        .controls {
            pointer-events: auto;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .stick-area {
            width: 140px; height: 140px;
            position: relative;
        }

        .btn {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 50%;
            color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px;
            backdrop-filter: blur(5px);
            transition: 0.1s;
            position: absolute;
        }
        
        .btn:active, .btn.pressed { background: rgba(0, 243, 255, 0.2); border-color: var(--neon-blue); transform: scale(0.95); }
        
        /* Left D-Pad */
        .btn-left { left: 0; top: 40px; width: 60px; height: 60px; }
        .btn-right { right: 0; top: 40px; width: 60px; height: 60px; }
        .btn-refill { bottom: 0; left: 35px; width: 70px; height: 30px; border-radius: 15px; font-size: 12px; border-color: var(--neon-red); }

        /* Right Action */
        .btn-up { left: 40px; top: 0; width: 60px; height: 40px; border-radius: 10px; }
        .btn-down { left: 40px; bottom: 0; width: 60px; height: 40px; border-radius: 10px; }
        .btn-shoot { 
            right: 0; top: 40px; width: 80px; height: 80px; 
            background: rgba(255, 42, 42, 0.15); border-color: var(--neon-red);
            box-shadow: 0 0 20px rgba(255, 42, 42, 0.2);
        }
        .btn-shoot:active { background: rgba(255, 42, 42, 0.5); }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-card {
            width: 85%; max-width: 400px;
            background: linear-gradient(160deg, #121420 0%, #080a10 100%);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .modal-card::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:4px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-red));
        }

        h1 { font-family: 'Orbitron'; margin: 0 0 10px 0; font-size: 28px; background: linear-gradient(#fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-family: 'Orbitron'; color: var(--neon-gold); margin: 0 0 20px 0; }
        p { color: #99a; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }

        .main-btn {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            background: linear-gradient(90deg, var(--neon-blue), #00a8ff);
            color: #000; font-family: 'Orbitron'; font-weight: 900; font-size: 18px;
            cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        .main-btn:active { transform: scale(0.98); filter: brightness(0.8); }

        .upgrade-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .upg-item {
            background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 12px; border-radius: 8px;
            text-align: left; transition: 0.2s;
        }
        .upg-item:active { background: rgba(255,255,255,0.1); }
        .upg-title { font-size: 12px; color: var(--neon-blue); font-weight: bold; }
        .upg-lvl { font-size: 10px; color: #666; margin: 4px 0; }
        .upg-cost { font-size: 14px; color: var(--neon-gold); font-family: 'Orbitron'; float: right; }

        /* NOTIFICATIONS */
        #float-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .float-txt {
            position: absolute; font-family: 'Orbitron'; font-weight: bold; font-size: 24px;
            text-shadow: 0 2px 0 #000; animation: floatUp 0.8s ease-out forwards;
        }
        @keyframes floatUp { 0%{opacity:1; transform:translateY(0) scale(0.5);} 100%{opacity:0; transform:translateY(-80px) scale(1.2);} }

        /* SCANLINE EFFECT */
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; opacity: 0.3;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <canvas id="game"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-panel">
                <div class="label">–î–ê–í–õ–ï–ù–ò–ï</div>
                <div class="bar-wrap"><div class="bar-fill" id="water-fill"></div></div>
            </div>
            <div class="hud-panel">
                <div class="label">–°–ß–ï–¢</div>
                <div class="value money" id="score-val">$0</div>
            </div>
            <div class="hud-panel">
                <div class="label">–£–ì–†–û–ó–ê</div>
                <div class="bar-wrap"><div class="bar-fill" id="heat-fill"></div></div>
            </div>
        </div>

        <div id="float-layer"></div>

        <div class="controls">
            <div class="stick-area">
                <div id="btn-l" class="btn btn-left">‚¨Ö</div>
                <div id="btn-r" class="btn btn-right">‚û°</div>
                <div id="btn-refill" class="btn btn-refill">‚ö° –í–û–î–ê</div>
            </div>
            <div class="stick-area">
                <div id="btn-u" class="btn btn-up">‚¨Ü</div>
                <div id="btn-d" class="btn btn-down">‚¨á</div>
                <div id="btn-shoot" class="btn btn-shoot">üî•</div>
            </div>
        </div>
    </div>

    <!-- START MENU -->
    <div id="modal-start" class="modal-overlay active">
        <div class="modal-card">
            <h1>INFERNO CITY</h1>
            <p>–ì–æ—Ä–æ–¥ –≤ –æ–≥–Ω–µ. –¢—ã - –ø–æ—Å–ª–µ–¥–Ω—è—è –ª–∏–Ω–∏—è –æ–±–æ—Ä–æ–Ω—ã. –¢—É—à–∏ –ø–æ–∂–∞—Ä—ã, —Å–ø–∞—Å–∞–π –ª—é–¥–µ–π, –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –Ω–∞ –∞–ø–≥—Ä–µ–π–¥—ã.</p>
            <div style="color: var(--neon-blue); font-size: 12px; margin-bottom: 20px;">–ü–†–û–ì–†–ï–°–° –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò</div>
            <button class="main-btn" onclick="Game.start()">–í–´–ï–ó–î –ù–ê –í–´–ó–û–í</button>
        </div>
    </div>

    <!-- SHOP MENU -->
    <div id="modal-shop" class="modal-overlay">
        <div class="modal-card">
            <h2>–ú–ò–°–°–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê</h2>
            <div id="level-stats" style="margin-bottom: 15px; font-size: 12px; color: #ccc;"></div>
            
            <div class="upgrade-grid">
                <div class="upg-item" onclick="Game.upgrade('pressure')">
                    <div class="upg-title">–¢–£–†–ë–û –ù–ê–°–û–°</div>
                    <div class="upg-lvl" id="lvl-pressure">LVL 1</div>
                    <div class="upg-cost" id="cost-pressure">$100</div>
                </div>
                <div class="upg-item" onclick="Game.upgrade('tank')">
                    <div class="upg-title">–ë–ê–ö –¢–ò–¢–ê–ù</div>
                    <div class="upg-lvl" id="lvl-tank">LVL 1</div>
                    <div class="upg-cost" id="cost-tank">$150</div>
                </div>
                <div class="upg-item" onclick="Game.upgrade('speed')">
                    <div class="upg-title">–î–í–ò–ì–ê–¢–ï–õ–¨ V8</div>
                    <div class="upg-lvl" id="lvl-speed">LVL 1</div>
                    <div class="upg-cost" id="cost-speed">$200</div>
                </div>
                <div class="upg-item" onclick="Game.upgrade('splitter')">
                    <div class="upg-title">–°–ü–õ–ò–¢–¢–ï–†</div>
                    <div class="upg-lvl" id="lvl-splitter">OFF</div>
                    <div class="upg-cost" id="cost-splitter">$500</div>
                </div>
            </div>
            <button class="main-btn" onclick="Game.nextLevel()">–°–õ–ï–î–£–Æ–©–ò–ô –†–ê–ô–û–ù >></button>
        </div>
    </div>

    <script>
        // --- SYSTEM & CONFIG ---
        const cvs = document.getElementById('game');
        const ctx = cvs.getContext('2d', { alpha: false, desynchronized: true });

        // Responsive Canvas
        let W, H, DPR;
        const resize = () => {
            W = window.innerWidth;
            H = window.innerHeight;
            DPR = Math.min(2, window.devicePixelRatio); // Optimization cap
            cvs.width = W * DPR;
            cvs.height = H * DPR;
            ctx.scale(DPR, DPR);
        };
        window.addEventListener('resize', resize);
        resize();

        // Save System
        const Save = {
            data: {
                money: 0,
                level: 1,
                upgrades: {
                    pressure: 1,
                    tank: 1,
                    speed: 1,
                    splitter: 0
                }
            },
            load() {
                const s = localStorage.getItem('inferno_save');
                if(s) this.data = JSON.parse(s);
            },
            save() {
                localStorage.setItem('inferno_save', JSON.stringify(this.data));
            }
        };
        Save.load();

        // Utils
        const rand = (min, max) => Math.random() * (max - min) + min;
        const vibrate = (ms) => { if(navigator.vibrate) navigator.vibrate(ms); };
        
        // --- GRAPHICS ENGINE ---
        const Camera = { x: 0, shake: 0 };
        
        class Particle {
            constructor() { this.active = false; }
            spawn(x, y, type, vx, vy) {
                this.x = x; this.y = y; this.type = type;
                this.vx = vx; this.vy = vy;
                this.life = 1.0; this.active = true;
                
                if(type === 'fire') {
                    this.size = rand(10, 25);
                    this.decay = rand(0.02, 0.04);
                    this.color = `hsla(${rand(0, 40)}, 100%, 50%,`; 
                } else if(type === 'water') {
                    this.size = rand(3, 6);
                    this.decay = 0;
                    this.color = '#00f3ff';
                } else if(type === 'smoke') {
                    this.size = rand(10, 30);
                    this.decay = 0.01;
                    this.color = '#333';
                } else if(type === 'spark') {
                    this.size = rand(1, 3);
                    this.decay = 0.05;
                    this.color = '#fff';
                } else if(type === 'steam') {
                    this.size = rand(5, 15);
                    this.decay = 0.03;
                    this.color = '#fff';
                }
            }
            update() {
                if(!this.active) return;
                this.life -= this.decay;
                
                // Physics
                if(this.type === 'water') {
                    this.vx += Game.wind * 0.01;
                    this.vy += 0.2; // Gravity
                    if(this.y > H - 50) this.life = 0; // Ground hit
                } else if(this.type === 'fire') {
                    this.vy += -0.05; // Rise
                    this.size *= 0.95;
                } else if(this.type === 'smoke') {
                    this.vx += Game.wind * 0.02;
                    this.vy -= 0.02;
                    this.size *= 1.01;
                }

                this.x += this.vx;
                this.y += this.vy;

                if(this.life <= 0) this.active = false;
            }
            draw() {
                if(!this.active) return;
                
                if(this.type === 'fire') {
                    ctx.globalCompositeOperation = 'lighter'; // Additive blending for GLOW
                    ctx.fillStyle = this.color + this.life + ')';
                } else if(this.type === 'water') {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.fillStyle = this.color;
                } else if(this.type === 'smoke') {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.fillStyle = `rgba(50,50,50,${this.life * 0.5})`;
                } else {
                    ctx.globalCompositeOperation = 'lighter';
                    ctx.fillStyle = `rgba(255,255,255,${this.life})`;
                }

                ctx.beginPath();
                ctx.arc(this.x - Camera.x, this.y, this.size, 0, Math.PI*2);
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        const Particles = {
            pool: new Array(800).fill().map(() => new Particle()),
            spawn(x, y, type, vx = 0, vy = 0) {
                const p = this.pool.find(p => !p.active);
                if(p) p.spawn(x, y, type, vx, vy);
            },
            updateAndDraw() {
                this.pool.forEach(p => { p.update(); p.draw(); });
            }
        };

        // --- GAME OBJECTS ---
        class Building {
            constructor(x, w, h) {
                this.x = x; this.w = w; this.h = h;
                this.windows = [];
                let floors = Math.floor(h / 60);
                let cols = Math.floor(w / 40);
                
                for(let f=0; f<floors; f++) {
                    for(let c=0; c<cols; c++) {
                        this.windows.push({
                            x: x + 5 + c * 40,
                            y: (H - 50) - (f * 60) - 50,
                            w: 30, h: 40,
                            hp: 0, max: 100,
                            hasPerson: Math.random() < 0.2,
                            saved: false, dead: false
                        });
                    }
                }
            }
            draw() {
                // Building Silhouette
                ctx.fillStyle = '#0a0a12';
                ctx.fillRect(this.x - Camera.x, H - 50 - this.h, this.w, this.h);
                // Neon Edge
                ctx.strokeStyle = '#1a1a2e';
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x - Camera.x, H - 50 - this.h, this.w, this.h);

                this.windows.forEach(win => {
                    let rx = win.x - Camera.x;
                    
                    // Window Base
                    if(win.hp >= 100) ctx.fillStyle = '#000'; // Burnt
                    else if(win.hp > 0) {
                        // Dynamic Fire Light
                        let flicker = Math.random() * 0.5 + 0.5;
                        ctx.fillStyle = `rgba(255, ${100 - win.hp}, 0, ${flicker})`;
                        
                        // Spawn Fire Particles
                        if(Math.random() < win.hp / 200) {
                            Particles.spawn(win.x + rand(0, win.w), win.y + win.h, 'fire', rand(-1,1), rand(-2,-4));
                            if(Math.random()<0.2) Particles.spawn(win.x + win.w/2, win.y, 'smoke', rand(-0.5,0.5), -2);
                        }
                    } else {
                        ctx.fillStyle = '#112'; // Dark window
                        if(Math.random() < 0.001) ctx.fillStyle = '#224'; // Random room light
                    }
                    
                    ctx.fillRect(rx, win.y, win.w, win.h);

                    // Person
                    if(win.hasPerson && !win.saved && !win.dead) {
                        ctx.fillStyle = '#fff';
                        ctx.font = '20px Arial';
                        ctx.fillText('üôã', rx + 5, win.y + 30);
                        if(win.hp > 0) {
                            ctx.fillStyle = '#f00';
                            ctx.font = 'bold 12px Arial';
                            ctx.fillText('SOS', rx + 2, win.y - 5);
                        }
                    }
                });
            }
        }

        const Truck = {
            x: 50, y: 0, w: 120, h: 50,
            angle: -0.7, water: 100, maxWater: 100,
            update() {
                this.y = H - 70;
                // Movement
                if(Input.l && this.x > 0) this.x -= (2 + Save.data.upgrades.speed);
                if(Input.r && this.x < Game.worldWidth - this.w) this.x += (2 + Save.data.upgrades.speed);
                
                // Cannon
                if(Input.u && this.angle > -2.5) this.angle -= 0.05;
                if(Input.d && this.angle < -0.1) this.angle += 0.05;

                // Camera follow
                Camera.x = this.x - W/2 + this.w/2;
                if(Camera.x < 0) Camera.x = 0;
                if(Camera.x > Game.worldWidth - W) Camera.x = Game.worldWidth - W;

                // Refill
                if(Input.refill) {
                    if(this.x < 150) { // Hydrant Zone
                        if(this.water < this.maxWater) {
                            this.water += 2;
                            if(this.water > this.maxWater) this.water = this.maxWater;
                        }
                    } else {
                        UI.float("–ì–ò–î–†–ê–ù–¢ –°–õ–ï–í–ê!", W/2, H/2, 'red');
                    }
                }

                // Shoot
                if(Input.shoot && this.water > 0) {
                    this.water -= 0.5;
                    if(Math.floor(this.water) % 5 === 0) vibrate(10);
                    
                    let power = 10 + Save.data.upgrades.pressure * 2;
                    let nozzleX = this.x + 80;
                    let nozzleY = this.y;
                    
                    // Main stream
                    Particles.spawn(nozzleX, nozzleY, 'water', Math.cos(this.angle)*power, Math.sin(this.angle)*power);
                    
                    // Splitter Upgrade
                    if(Save.data.upgrades.splitter) {
                        Particles.spawn(nozzleX, nozzleY, 'water', Math.cos(this.angle-0.1)*power, Math.sin(this.angle-0.1)*power);
                        Particles.spawn(nozzleX, nozzleY, 'water', Math.cos(this.angle+0.1)*power, Math.sin(this.angle+0.1)*power);
                    }
                }
            },
            draw() {
                let rx = this.x - Camera.x;
                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(rx + 10, this.y + 45, this.w - 20, 10);

                // Body
                ctx.fillStyle = '#e00';
                ctx.fillRect(rx, this.y, this.w, this.h);
                // Stripe
                ctx.fillStyle = '#fff';
                ctx.fillRect(rx - 5, this.y + 20, this.w + 10, 10);
                
                // Wheels
                ctx.fillStyle = '#111';
                ctx.beginPath(); ctx.arc(rx + 30, this.y + 50, 15, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(rx + 90, this.y + 50, 15, 0, Math.PI*2); ctx.fill();
                // Rims
                ctx.strokeStyle = '#888'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(rx + 30, this.y + 50, 8, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.arc(rx + 90, this.y + 50, 8, 0, Math.PI*2); ctx.stroke();

                // Cannon
                ctx.save();
                ctx.translate(rx + 80, this.y);
                ctx.rotate(this.angle);
                ctx.fillStyle = '#aaa';
                ctx.fillRect(0, -5, 40, 10);
                ctx.fillStyle = '#444'; // Base
                ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill();
                ctx.restore();

                // Lights
                let blink = Math.sin(Date.now()/100) > 0;
                ctx.fillStyle = blink ? '#f00' : '#500';
                ctx.shadowBlur = blink ? 20 : 0; ctx.shadowColor = '#f00';
                ctx.fillRect(rx + 10, this.y - 10, 15, 10);
                ctx.shadowBlur = 0;
            }
        };

        // --- GAME LOGIC ---
        const Game = {
            active: false,
            buildings: [],
            wind: 0,
            heat: 0,
            maxHeat: 1000,
            worldWidth: 2000,

            start() {
                document.getElementById('modal-start').classList.remove('active');
                this.loadLevel();
                this.active = true;
                loop();
            },

            loadLevel() {
                this.buildings = [];
                this.heat = 0;
                this.worldWidth = 1500 + Save.data.level * 500;
                Truck.x = 100;
                Truck.maxWater = 100 + Save.data.upgrades.tank * 50;
                Truck.water = Truck.maxWater;
                
                // Wind System
                this.wind = (Math.random() - 0.5) * (Save.data.level * 2);
                if(Math.abs(this.wind) > 1) UI.float(this.wind > 0 ? "–í–ï–¢–ï–† >>" : "<< –í–ï–¢–ï–†", W/2, H/3, "#0ff");

                // Generate City
                let cx = 250;
                let bCount = 3 + Math.floor(Save.data.level / 2);
                for(let i=0; i<bCount; i++) {
                    let w = rand(120, 200);
                    let h = rand(150, 250 + Save.data.level * 30);
                    this.buildings.push(new Building(cx, w, h));
                    cx += w + rand(50, 100);
                }

                // Ignite
                let wins = this.buildings.flatMap(b => b.windows);
                let fires = 3 + Save.data.level;
                for(let i=0; i<fires; i++) {
                    wins[Math.floor(Math.random()*wins.length)].hp = 50;
                }
            },

            update() {
                Truck.update();
                
                // Particles Collision
                Particles.pool.forEach(p => {
                    if(!p.active || p.type !== 'water') return;
                    
                    this.buildings.forEach(b => {
                        // Simple bounding box check optimization
                        if(p.x < b.x || p.x > b.x + b.w) return;

                        b.windows.forEach(w => {
                            if(w.hp > 0 && w.hp < 100) {
                                if(p.x > w.x && p.x < w.x + w.w && p.y > w.y && p.y < w.y + w.h) {
                                    p.active = false; // Water consumed
                                    // Steam effect
                                    Particles.spawn(p.x, p.y, 'steam', rand(-1,1), -1);
                                    
                                    w.hp -= 2;
                                    if(w.hp <= 0) {
                                        w.hp = 0;
                                        Save.data.money += 10;
                                        UI.float("+$10", w.x - Camera.x, w.y, "gold");
                                        
                                        if(w.hasPerson && !w.dead) {
                                            w.saved = true;
                                            Save.data.money += 100;
                                            UI.float("–°–ü–ê–°–ï–ù! +$100", w.x - Camera.x, w.y - 30, "#0f0");
                                            vibrate(100);
                                            // Sparkle
                                            for(let k=0; k<10; k++) Particles.spawn(w.x, w.y, 'spark', rand(-5,5), rand(-5,5));
                                        }
                                    }
                                }
                            }
                        });
                    });
                });

                // Fire Logic
                let burning = 0;
                this.buildings.forEach(b => {
                    b.windows.forEach(w => {
                        if(w.hp > 0 && w.hp < 100) {
                            burning++;
                            w.hp += 0.05 + (Save.data.level * 0.01);
                            if(w.hp >= 100) {
                                w.hp = 100; // Burnt
                                if(w.hasPerson && !w.saved && !w.dead) {
                                    w.dead = true;
                                    this.heat += 200; // Penalty
                                    UI.float("–ü–û–¢–ï–†–Ø!", w.x - Camera.x, w.y, "red");
                                    vibrate(200);
                                }
                            }
                        }
                    });
                });

                this.heat += burning * 0.1;
                if(this.heat >= this.maxHeat) {
                    // Fail logic could go here (reset level)
                    this.heat = this.maxHeat;
                }

                // Check Win
                if(burning === 0 && Particles.pool.filter(p => p.active && p.type==='water').length === 0) {
                     // Add small delay
                     if(!this.winTimer) this.winTimer = setTimeout(() => this.levelComplete(), 1000);
                } else {
                    this.winTimer = null;
                }
            },

            draw() {
                // Sky
                let grad = ctx.createLinearGradient(0, 0, 0, H);
                grad.addColorStop(0, '#020205');
                grad.addColorStop(1, '#1a1a2e');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, W, H);

                // Parallax Stars/City
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                for(let i=0; i<50; i++) {
                    let sx = (i * 100 - Camera.x * 0.2) % W;
                    if(sx < 0) sx += W;
                    ctx.fillRect(sx, rand(0, H/2), 2, 2);
                }

                // Ground
                ctx.fillStyle = '#08080c';
                ctx.fillRect(0, H - 50, W, 50);
                ctx.fillStyle = '#111';
                ctx.fillRect(0, H - 50, W, 4); // Curb

                // Hydrant (Static)
                let hyX = 100 - Camera.x;
                if(hyX > -50 && hyX < W + 50) {
                    ctx.fillStyle = '#f33';
                    ctx.fillRect(hyX, H - 70, 20, 20);
                }

                // Game Objects
                this.buildings.forEach(b => b.draw());
                Truck.draw();
                Particles.updateAndDraw();

                // UI Sync
                document.getElementById('score-val').innerText = '$' + Save.data.money;
                document.getElementById('water-fill').style.width = (Truck.water / Truck.maxWater * 100) + '%';
                document.getElementById('heat-fill').style.width = (this.heat / this.maxHeat * 100) + '%';
            },
            
            levelComplete() {
                this.active = false;
                Save.save();
                document.getElementById('modal-shop').classList.add('active');
                document.getElementById('level-stats').innerText = `–†–ê–ô–û–ù ${Save.data.level} –ó–ê–ß–ò–©–ï–ù. –ë–ê–õ–ê–ù–°: $${Save.data.money}`;
                this.updateShopUI();
            },
            
            nextLevel() {
                Save.data.level++;
                Save.save();
                document.getElementById('modal-shop').classList.remove('active');
                this.loadLevel();
                this.active = true;
                loop();
            },
            
            upgrade(type) {
                let costs = {
                    pressure: 100 * Save.data.upgrades.pressure,
                    tank: 150 * Save.data.upgrades.tank,
                    speed: 200 * Save.data.upgrades.speed,
                    splitter: 500
                };
                
                let cost = costs[type];
                
                if(Save.data.money >= cost) {
                    if(type === 'splitter' && Save.data.upgrades.splitter) return;
                    
                    Save.data.money -= cost;
                    Save.data.upgrades[type]++;
                    Save.save();
                    this.updateShopUI();
                    UI.float("–ö–£–ü–õ–ï–ù–û!", W/2, H/2, "#0f0");
                }
            },
            
            updateShopUI() {
                const up = Save.data.upgrades;
                document.getElementById('lvl-pressure').innerText = 'LVL ' + up.pressure;
                document.getElementById('cost-pressure').innerText = '$' + (100 * up.pressure);
                
                document.getElementById('lvl-tank').innerText = 'LVL ' + up.tank;
                document.getElementById('cost-tank').innerText = '$' + (150 * up.tank);
                
                document.getElementById('lvl-speed').innerText = 'LVL ' + up.speed;
                document.getElementById('cost-speed').innerText = '$' + (200 * up.speed);
                
                document.getElementById('lvl-splitter').innerText = up.splitter ? "–ê–ö–¢–ò–í–ï–ù" : "OFF";
                document.getElementById('cost-splitter').innerText = up.splitter ? "---" : "$500";
                
                // Update money header in shop
                document.getElementById('level-stats').innerText = `–ë–ê–õ–ê–ù–°: $${Save.data.money}`;
            }
        };

        // --- INPUT HANDLER ---
        const Input = { l:0, r:0, u:0, d:0, shoot:0, refill:0 };
        const bindBtn = (id, key) => {
            const el = document.getElementById(id);
            const on = (e) => { e.preventDefault(); Input[key] = 1; el.classList.add('pressed'); };
            const off = (e) => { e.preventDefault(); Input[key] = 0; el.classList.remove('pressed'); };
            el.addEventListener('touchstart', on, {passive:false});
            el.addEventListener('touchend', off);
            el.addEventListener('mousedown', on);
            el.addEventListener('mouseup', off);
        };
        bindBtn('btn-l', 'l'); bindBtn('btn-r', 'r');
        bindBtn('btn-u', 'u'); bindBtn('btn-d', 'd');
        bindBtn('btn-shoot', 'shoot'); bindBtn('btn-refill', 'refill');

        // UI Helper
        const UI = {
            float(text, x, y, col) {
                let el = document.createElement('div');
                el.className = 'float-txt';
                el.innerText = text;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                el.style.color = col;
                document.getElementById('float-layer').appendChild(el);
                setTimeout(() => el.remove(), 800);
            }
        };

        // --- MAIN LOOP ---
        function loop() {
            if(!Game.active) return;
            requestAnimationFrame(loop);
            Game.update();
            Game.draw();
        }

        // Init Telegram
        if(window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

    </script>
</body>
</html>
