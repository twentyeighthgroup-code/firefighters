<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Пожарный: Спасатель Города</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik+Burned&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      background:#110011;
      color:#fff;
      font-family:Arial,sans-serif;
      overflow:hidden;
      height:100vh;
      touch-action:manipulation;
    }
    #game{background:url('https://i.ibb.co.com/0jZ1yKX/fire-bg.jpg') center/cover; position:relative; height:100%;}

    #hud{
      position:absolute; top:0; left:0; right:0; padding:12px;
      background:rgba(0,0,0,0.7); display:flex; justify-content:space-between; z-index:100;
      backdrop-filter:blur(8px);
    }
    .stat{
      background:rgba(255,50,50,0.9); padding:8px 16px; border-radius:50px; font-weight:bold;
      box-shadow:0 0 15px #ff0000; min-width:110px; text-align:center;
    }

    /* Огонь */
    .fire{
      position:absolute; width:90px; height:130px; pointer-events:all; cursor:pointer;
      background:radial-gradient(circle at bottom,#ff9800,#f44336,#b71c1c);
      border-radius:50% 50% 50% 50%/60% 60% 40% 40%;
      animation:flame 1.4s infinite alternate;
      box-shadow:0 0 50px #ff3300;
    }
    @keyframes flame{0%{transform:scale(1) translateY(0);}100%{transform:scale(1.25) translateY(-25px);}}

    /* Человек в окне */
    .person{
      position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
      width:40px; height:60px; pointer-events:none;
      background:url('https://i.ibb.co.com/8X8Y3fJ/person-scream.png') center/contain no-repeat;
      animation:wave 1s infinite;
    }
    @keyframes wave{0%,100%{transform:translateX(-50%) rotate(0);} 25%{transform:translateX(-50%) rotate(15deg);} 75%{transform:translateX(-50%) rotate(-15deg);}}

    /* Машина */
    #truck{
      position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
      width:200px; height:110px;
      background:url('https://i.ibb.co.com/4pKXvG7/firetruck.png') center/contain no-repeat;
      z-index:50;
    }

    /* Попапы */
    .popup{
      position:absolute; font-size:36px; font-weight:bold; pointer-events:none;
      animation:float 1.2s ease-out forwards;
    }
    @keyframes float{0%{transform:translateY(0);opacity:1;}100%{transform:translateY(-180px);opacity:0;}}

    #lives{display:flex; gap:8px;}
    .heart{font-size:28px;}

    /* Меню, магазин, достижения — без изменений (оставил как было) */
    #menu,#shop,#achieves,#gameover{
      position:absolute; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.97); display:none; flex-direction:column;
      align-items:center; justify-content:center; z-index:200;
    }
    .btn{
      margin:12px; padding:18px 45px; background:linear-gradient(#ff4444,#cc0000);
      border:none; border-radius:50px; color:white; font-size:22px; font-weight:bold;
      box-shadow:0 6px 25px rgba(255,0,0,0.6); cursor:pointer;
    }
    .btn:active{transform:scale(0.94);}
    h1{font-family:'Rubik Burned',cursive; font-size:56px; color:#ff3300; text-shadow:0 0 25px #ff0000;}

    #level-up{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:90px; color:gold; text-shadow:0 0 40px gold; animation:pulse 2s infinite; display:none; z-index:300;
    }
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.3);}}
  </style>
</head>
<body>

<div id="game">
  <div id="hud">
    <div class="stat">Огонь: <span id="fireCount">0</span></div>
    <div class="stat">Люди: <span id="saved">0</span>/ <span id="totalPeople">0</span></div>
    <div class="stat">Жизни: <div id="lives"><span class="heart">❤️</span><span class="heart">❤️</span><span class="heart">❤️</span></div></div>
    <div class="stat">Уровень <span id="level">1</span></div>
    <div class="stat">Монеты <span id="money">0</span></div>
  </div>

  <div id="truck"></div>
  <div id="fire-container"></div>

  <div id="level-up">УРОВЕНЬ ПРОЙДЕН!</div>

  <!-- Главное меню -->
  <div id="menu">
    <h1>ПОЖАРНЫЙ: СПАСАТЕЛЬ</h1>
    <button class="btn" onclick="startGame()">НАЧАТЬ МИССИЮ</button>
    <button class="btn" onclick="openShop()">МАГАЗИН</button>
    <button class="btn" onclick="openAchieves()">ДОСТИЖЕНИЯ</button>
  </div>

  <!-- Магазин (добавил новые улучшения) -->
  <div id="shop">
    <h1>МАГАЗИН УЛУЧШЕНИЙ</h1>
    <button class="btn" onclick="buy('hose')">Мощный шланг +50% — 500</button>
    <button class="btn" onclick="buy('ladder')">Длинная лестница (спасение ×2) — 2000</button>
    <button class="btn" onclick="buy('speed')">Скорость машины +50% — 1000</button>
    <button class="btn" onclick="buy('auto')">Автоспасение людей — 8000</button>
    <button class="btn" onclick="buy('life')">Доп. жизнь ❤️ — 3000</button>
    <button class="btn" onclick="closeShop()">НАЗАД</button>
  </div>

  <div id="achieves">
    <h1>ДОСТИЖЕНИЯ</h1>
    <div class="achievement">Спаситель 100 человек ❤️</div>
    <div class="achievement">Без потерь на 10 уровнях</div>
    <div class="achievement">Легенда пожарной охраны — 50 уровень</div>
    <button class="btn" onclick="closeAchieves()">НАЗАД</button>
  </div>

  <div id="gameover">
    <h1>МИССИЯ ПРОВАЛЕНА</h1>
    <p style="font-size:24px;margin:20px;">Сгорело слишком много людей...</p>
    <button class="btn" onclick="startGame()">ПОПРОБОВАТЬ СНОВА</button>
    <button class="btn" onclick="document.getElementById('gameover').style.display='none';document.getElementById('menu').style.display='flex';">МЕНЮ</button>
  </div>
</div>

<script>
Telegram.WebApp.ready(); Telegram.WebApp.expand();

let money = 0, level = 1, saved = 0, lost = 0, totalPeople = 0;
let lives = 3;
let hosePower = 1, ladderPower = 1, autoSave = false;
let gameActive = false;

const fireContainer = document.getElementById('fire-container');
const moneyEl = document.getElementById('money');
const savedEl = document.getElementById('saved');
const totalEl = document.getElementById('totalPeople');
const levelEl = document.getElementById('level');

const sounds = {
  save: new Audio('https://cdn.freesound.org/previews/321/321652_5123856-lq.mp3'),    // крик → спасение
  burn: new Audio('https://cdn.freesound.org/previews/276/276956_5123856-lq.mp3'),    // человек сгорел
  extinguish: new Audio('https://cdn.freesound.org/previews/612/612345_5674468-lq.mp3'),
  levelup: new Audio('https://cdn.freesound.org/previews/320/320656_5270804-lq.mp3')
};

function createFireWithPeople() {
  if (!gameActive) return;

  const fire = document.createElement('div');
  fire.className = 'fire';
  const x = Math.random() * (innerWidth - 120) + 60;
  const y = Math.random() * (innerHeight - 350) + 100;
  fire.style.left = x + 'px';
  fire.style.top = y + 'px';
  fireContainer.appendChild(fire);

  // 70% шанс появления человека на уровне 3+
  const hasPerson = level >= 3 && Math.random() < 0.7;
  let person = null;
  if (hasPerson) {
    totalPeople++;
    totalEl.textContent = totalPeople;

    person = document.createElement('div');
    person.className = 'person';
    fire.appendChild(person);
  }

  const clickHandler = () => {
    if (!gameActive) return;
    Telegram.WebApp.HapticFeedback.impactOccurred('heavy');

    // Тушим огонь
    money += 10 * hosePower;
    sounds.extinguish.play();

    // Если был человек — спасаем!
    if (person) {
      saved++;
      savedEl.textContent = saved;
      money += 50 * ladderPower;  // спасение — жирный бонус
      sounds.save.play();

      popup('+СПАСЕН!', x, y, '#00ff00');
      popup('+' + (50 * ladderPower), x + 60, y - 40, '#ffff00');
    } else {
      popup('+' + (10 * hosePower), x + 20, y, '#ffff00');
    }

    fire.style.transition = 'all 0.5s';
    fire.style.transform = 'scale(0)';
    fire.style.opacity = '0';
    setTimeout(() => fire.remove(), 600);
    fire.removeEventListener('click', clickHandler);
  };

  fire.addEventListener('click', clickHandler);
  fire.addEventListener('touchstart', e => {e.preventDefault(); clickHandler();});

  // Если не потушили вовремя
  setTimeout(() => {
    if (fire && fire.parentNode) {
      if (person) {
        lost++;
        lives--;
        updateLives();
        sounds.burn.play();
        popup('ЧЕЛОВЕК СГОРЕЛ!', x-30, y-50, '#ff0000');
        if (lives <= 0) gameOver();
      }
      fire.remove();
    }
  }, Math.max(6000, 10000 - level * 300));
}

// Попап
function popup(text, x, y, color = '#ffff00') {
  const el = document.createElement('div');
  el.className = 'popup';
  el.textContent = text;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.style.color = color;
  el.style.textShadow = '0 0 15px ' + color;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1500);
}

function updateLives() {
  const hearts = document.querySelectorAll('.heart');
  for(let i=0; i<hearts.length; i++) {
    hearts[i].style.opacity = i < lives ? 1 : 0.3;
  }
}

function checkLevelUp() {
  if (saved >= level * 15) {
    level++;
    levelEl.textContent = level;
    document.getElementById('level-up').style.display = 'block';
    sounds.levelup.play();
    setTimeout(() => document.getElementById('level-up').style.display = 'none', 3000);
  }
}

function spawnLoop() {
  if (!gameActive) return;
  createFireWithPeople();
  const delay = Math.max(1000, 4000 - level * 180);
  setTimeout(spawnLoop, delay);
}

function gameOver() {
  gameActive = false;
  document.getElementById('gameover').style.display = 'flex';
  Telegram.WebApp.HapticFeedback.notificationOccurred('error');
}

function startGame() {
  document.querySelectorAll('#menu,#shop,#achieves,#gameover').forEach(m => m.style.display = 'none');
  fireContainer.innerHTML = '';
  gameActive = true;
  saved = lost = totalPeople = 0;
  lives = 3 + (localStorage.getItem('extraLives') || 0);
  updateLives();
  savedEl.textContent = totalEl.textContent = '0';
  spawnLoop();
}

// Магазин
function buy(item) {
  if (item === 'hose' && money >= 500) { money -= 500; hosePower += 0.5; }
  if (item === 'ladder' && money >= 2000) { money -= 2000; ladderPower += 1; }
  if (item === 'speed' && money >= 1000) { money -= 1000; document.getElementById('truck').style.animation = `drive ${3/(1 + (ladderPower-1))}s infinite linear`; }
  if (item === 'auto' && money >= 8000 && !autoSave) {
    money -= 8000; autoSave = true;
    setInterval(() => {
      if (!gameActive) return;
      const persons = document.querySelectorAll('.person');
      if (persons.length > 0) persons[0].parentNode.click();
    }, 1200);
  }
  if (item === 'life' && money >= 3000) {
    money -= 3000; lives++; localStorage.setItem('extraLives', lives-3);
    updateLives();
  }
  moneyEl.textContent = money;
}

// Меню функции
function openShop(){document.getElementById('menu').style.display='none';document.getElementById('shop').style.display='flex';}
function closeShop(){document.getElementById('shop').style.display='none';document.getElementById('menu').style.display='flex';}
function openAchieves(){document.getElementById('menu').style.display='none';document.getElementById('achieves').style.display='flex';}
function closeAchieves(){document.getElementById('achieves').style.display='none';document.getElementById('menu').style.display='flex';}

window.onload = () => document.getElementById('menu').style.display = 'flex';
</script>
</body>
</html>
